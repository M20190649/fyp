\documentclass[12pt, a4paper]{report}

\usepackage{fyp}

%%these packages are not really necessary if you dont need the code and proofs environments
%%so if you like you can delete from here till the next comment
%%note that there are some examples below which obviously won't work once you remove this part
\usepackage{verbatim}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage[hidelinks]{hyperref}
\usepackage{graphicx}
\usepackage{lmodern,textcomp}
\usepackage{algcompatible}
\usepackage{algorithm}
\usepackage{enumitem}
\usepackage{varwidth}
\usepackage{mathtools}
\usepackage[noend]{algpseudocode}


\usepackage{caption}
\usepackage{subcaption}
\usepackage{graphicx}



\makeatletter
\def\BState{\State\hskip-\ALG@thistlm}
\makeatother

\algdef{SE}[SUBALG]{Indent}{EndIndent}{}{\algorithmicend\ }%
\algtext*{Indent}
\algtext*{EndIndent}

\DeclarePairedDelimiter{\ceil}{\lceil}{\rceil}

%%this environment is useful if you have code snippets
\newenvironment{code}
{\footnotesize\verbatim}{\endverbatim\normalfont}




\graphicspath{ {images/} }

%%the following environments are useful to present proofs in your thesis
\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]
\theoremstyle{definition}%plain}
\newtheorem{example}{Example}[section]
\theoremstyle{definition}%remark}
\newtheorem{proposition}{Proposition}[section]
\theoremstyle{definition}%remark}
\newtheorem{lemma}{Lemma}[section]
\theoremstyle{definition}%remark}
\newtheorem{corollary}{Corollary}[section]
\theoremstyle{definition}%remark}
\newtheorem{theorem}{Theorem}[section]
%%you can delete till here if you dont need the code and proofs environments

\setlength{\headheight}{15pt}
%\overfullrule=15pt

\begin{document}


%%make sure to enter this information
\title{Pin Pointing Pain Points: Vehicular traffic flow intensity detection and prediction through mobile data usage.}
\author{Maurice Saliba}
\date{28-06-2018}
\supervisor{Dr Charlie Abela}
\cosupervisor{Dr Colin Layfield}
\department{Faculty of ICT}
\universitycrestpath{crest}
\submitdate{28-06-2018} 

\frontmatter


\begin{acknowledgements}

I would first like to thank my supervisor Dr. Charlie Abela and Co-supervisor Dr. Colin Layfield who taught me amongst many other things one important approach and they kept persisting on it - \textit{To let the data speak for itself}. Discussing with them gradual achievements and caveats made it possible to foster insight.

This dissertation would not have been possible without the assistance of GO p.l.c through Mr. Joe Attard in order to get the anonymized mobile usage dataset and to get the high end technological resources needed for highly intensive processing. My colleagues at GO were also of great support and inspiration especially when I discussed with them certain technical aspects of the project.

On a personal note I would like to thank my wife Andrea for her great support, love and constant encouragement. I would like to thank also my parents Benny and Carmen and the rest of my family especially my nephew Kyle and niece Shirley who proved to be a useful forced distraction when needed. I cannot not mention my close friends who did their best to make me look forward to strive towards completion by constantly sending me pictures of them having beers on a great night out without me. 

Last but not least I would like to thank all the academic and non-academic staff of the department of artificial intelligence. It was a great academic journey that enriched my experience and perspective towards the world of science.



\end{acknowledgements}
       
\begin{abstract}
Multi-modal originated vehicular traffic flow data can be obtained with various techniques. To what extent this data is reliable, complete, timely and readily available requires a thorough analysis of past work and currently available solutions. A novel approach consisting of an ensemble of machine learning and data-mining techniques is being proposed. 
An anonymized mobile phone usage dataset from a telecommunications provider in Malta is used first to carry out basic traffic analytics. Then an origin-destination (OD) matrix based on the largest two clusters of activity per user will be computed to infer user trips between these clusters over time. Routes for these trips are retrieved with open source routing tools and obtained data pertaining to way nodes along these routes further enrich trip information. Spatial binning is then used to deduce the aggregate distribution of traffic load on the traffic network.  The OD matrix and grid network load are subsequently used to build a Neural Network predictive model. Several previous works \cite{Laurila2012,Hoteit2014} that carried out invaluable research in this field lacked on-line data in quality and quantity. They were at times compelled to devise corrective measures and carry out simulations to cater for such shortcomings. Having the luxury to avail of mobile call and data historical records will make it more possible to fine tune a better predictive model and evaluate it. Industry standard visualization tools were used to portray AI generated traffic patterns together with flow intensity projected in the geospatial dimension.
The final results are satisfactory and the built models can effectively be used to both measure and predict traffic flow  counts in specific locations. Adding dynamic traffic assignment to the proposed solution would give more accurate results especially for traffic points that tend to be congested. 
\end{abstract}

\tableofcontents

\listoffigures

\listoftables



\mainmatter

\chapter{Introduction} \label{chapter:introduction}

\section{Economic development and urbanization impact on transport} \label{section:introduction:economic_development}

Land transport is a societal reality that is required for displacement of people for work, 
leisure and other purposes. Transport is important as well to deliver goods and services. Land transportation has undoubtedly evolved with a fast pace and late technology advancements are making vehicular transportation more efficient, less polluting, faster, safer and more comfortable. There are many land transport modes which include bus, rail and private car as the most generally used.

Economic development and urbanization comes at a cost. It surely has a direct impact on the increase of traffic congestion and all undesirable consequences it brings with it. Traffic congestion is especially synonymous with urban places where private car is the preferred mode of travelling. \cite{EUTransportDirectorate2018} mentions how traffic congestion in urban areas in the EU is costing 100 billion every year which amounts to 1\% of the EU GDP. \cite{Colak2015} ellaborates on the crippling effect on the economy because of traffic congestion. Traffic congestion amounted to 43\% (\texteuro117.9 million) of external costs in Malta in 2012, which is the origin of the mobile traces datasource used in this study \cite{Attard2015}. Other causes of external costs related to traffic include accidents, climate change, air pollution and noise which are all directly incremented by traffic congestion. No policy change scenario envisages an external cost of \texteuro151.1 million and \texteuro154.1 million for the years 2020 and 2030 respectively incurred on the economy of Malta.

In the US traffic congestion is similarly a cause of concern. Interesting but worrying facts are listed in a US mobility research done in 2015 \cite{Schrank.2015}. It states that the extra miles travelled by Americans in 2014 were 6.9 million at the cost of \textdollar160 billion. Congestion costs in the USA is on the increase. In the year 2000 it was reported to be at the level of \textdollar114 billion.

Traffic delays impact direly also the shipment industry. Travel costs increase when travel time increases.  Pick-up and delivery times are more approximative. Transport companies need to take costly measures in order to make up for this and the increase in cost is more often than not passed to the consumer  \cite{Schrank.2015} \cite{CambridgeSystematicsInc.2005}.

\section{Addressing Traffic congestion} \label{section:introduction:addressing_traffic_congestion}

Car users and even public transport users (since buses cannot avoid traffic although use of it alleviates it) tend to get rather frustrated from lost time on the road. This time is deducted from a healthy lifestyle or from productivity hours. 

Driver self adaptation measures help to smartly mitigate delay times. Individual drivers can hear radio adverts or check CCTV to enquire the traffic situation before departing or even while driving for better planning. Use of software such as Google maps, Apple maps or Waze help to have an informed decision how to schedule trips and decide what route to take.  These applications might even suggest to take other transport modes because it is more convenient especially in terms of less time to get to destination.

Addressing traffic delays should be addressed within a wider scope. Efficient traffic management should be on top of government transportation agencies agenda. Traffic management is multi-faceted especially the urban one. Possible measures that can be taken by transport authorities include making different modes of transport available and encourage the public to use it. Smart technology is a good candidate to alleviate travelling frustration by giving information,instructions and control parameters that have a say on traffic. For more uptake of public transport the public for instance can be informed and educated through mobile applications.  Mobile applications can be used to make the public transport experience more efficient, practical and the preferred choice. There are other deterrents such as increases in vehicle license tax and adding of parking fees to force drivers off the road and make them use public transport or go for any generic modal shift. But these are rather unpopular measures and policy making agents are susceptible to pressure in such a way that they are less proactive to implement such measures.

Other measures to tackle traffic problems is by enforcing traffic laws. This would diminish road accidents or casual road blockages that can cause flow disruptions. CCTV road network monitoring would be helpful to inform drivers to take alternative routes. CCTV could be used also for deployment of traffic management personnel in problematic areas. License number plate recognition through camera feeds processing can be used to measure traffic flow and even to apply a toll to users in certain traffic zones as a deterrent for private car use.  Park and ride systems may shift away concentration of traffic from urban centres.  \cite{AlNuaimi2015} for instance suggests how concerted efforts can lead to smart cities by analysing static data and make infrastructural changes by opening or modifying roads. Dynamic data then would be used to manage traffic lights to alleviate congestion, inform the public through their smart phones about the traffic status and orchestrate shipping movement for the supply chain.

Investment in the transport infrastructure to expand capacity is difficult to directly justify with a simple cost benefit analysis model. Increase in road capacity might seem a simple straightforward solution to alleviate traffic.  However infrastructure alterations might not necessarily equate to easing of traffic. Such costly changes might just spatially shift the problem elsewhere or not lead to the expected result. Forecasting of the gains made by road capacity increase or any other transport system changes may be distorted if induced traffic is not taken in consideration. Induced traffic may result from changes in route choice, peak hour traffic, modal split, overall transport volume, land use and quality of public transport services \cite{Naess2012}. When formulating return on investment functions induced traffic should not be ignored.


\section{Traffic information and management systems}\label{section:introduction:traffic_information_and_management_systems}

Traffic management would primarily consist of a systematic approach to monitor accurately, with wide coverage what is the traffic status in the road network. In order that this information is kept relevant it needs to be constantly updated and gathered in a reliable fashion. Once such information is acquired intelligent traffic management systems architectures can be designed around static data and traffic control is based  on constant input feed stream processing. Obviously the latter is more challenging in terms of computational resources and design but is more reactive to abnormal situations such as accidents or unusual weather conditions since it is modelled on a running sample \cite{Toole2015}. Traffic related data stream processing might entail heavy real time processing of high variety data coming from multiple sources. Modern approaches such as big data based information systems become essential in order to create automated control systems that alleviate the load on the transport network.

Traffic information Systems may be based on mobile data as main source of information. These type of systems would require that mobile data collection and its processing has wide coverage, is reliable and accurate and updated with high frequency \cite{Leduc2008}. Less coverage is to be expected in rural areas where base stations are highly dispersed when compared to urban areas. Mobile vehicle geolocation cannot be used for traffic flow counts on lanes as it can be done with inductive loops. Frequency of updates refers to collection of data that probes the traffic situation (counts) and also to the amount of fresh updates users get from the traffic information systems in real time.

\section{Traveller centric traffic flow probing} \label{section:introduction:traveller_centric_traffic_flow_probing}

%TODO - give some notes on floating car data

Obviously the dynamics of traffic flow is determined by the travel needs of the masses. The daily commutes of every individual impacts those of others. The interaction at large scale of all the vehicles in a time series is difficult to model and then predict how traffic is affected along the course of the day. Traffic sensors, cameras and induction loops are all sources of information that can be lead to both detect high traffic intensity or even forecast it beforehand.  However the coverage these techniques offer is limited. Camera feeds and inductive-loop detectors cannot be installed in every road of the transport infrastructure. Crowd-sourced information that gives information on mobility traces enables new approaches how to make the road infrastructure management, both inter-towns and intra-cities, smarter. Vehicles and people that are on the move become traffic measurement mediums.

Long before the information era started, spatio-temporal data on human mobility was collected in various forms and modalities. There are various reasons that raise interest in the scientific community for gathering such information. One of the methods used to gather such information is to do straightforward surveys\cite{Calabrese2013,Colak2015}. However these are expensive in terms of manual work needed to carry out and a lot of human resources are needed to gather information. Besides they could only give a snapshot of reality at a given point in time.  Generally these type of surveys are done every five to ten years \cite{Toole2015}. The data made available would be too static and increasing the frequency of survey taking would directly require more human resources assigned to the process. Given that telecommunications came into the picture and there was a wide adoption of its services at the turn of the millennium one could gather data more frequently in vaster amounts and in an automated fashion from mobile devices. The sample domain got even wider. A limitation which comes with mobile phone data is the lack of background known on the travellers. Surveys gather such information and make stratified sampling possible in order to have a more representative sample \cite{Colak2015}.

\section{Application of mobile traces analytics} \label{section:introduction:application_mobile_traces}

Primarily mobile traces would lead to location based services that have a wide application spectrum that go beyond solving mobility issues \cite{Hoteit2014,Calabrese2013,Gonzalez2008,Hoteit2016}. An individual's location and its relation with that of others within the context of the continuum of time is invaluable in many ways. This formidable datasource however poses a challenge. Location data, which usually comes in large amounts, has to be harvested, ingested efficiently and ideally processed in real time for the required final purpose which is value added location based services.

The range of application and branches of research abound on remote collection of mobile users' geolocation information.   To name a few applications include: traffic patterns and prediction modelling, crowd management, hotspot detection, lost device recovery, emergency rescue, use for investigative authorities,  location-based recommendation and advertising systems, contextualized information, social interaction based application, epidemiology etc.  

\cite{Calabrese2013} went even further to emphasize that such studies on human mobility patterns would be vital for better sustainable urban planning and a boost for the environment's well being given that transportation in 2004 accounted for 22\% of primary energy use.

Mobile device geolocation data surely proved to be useful to setup a platform to predict how traffic/commuting patterns evolve during different time-frames such as weekdays in contrast with weekends \cite{Steenbruggen2015}. Prediction of traffic patterns would also include jam detection \cite{Hoteit2014}.  Macroscopic monitoring and analysis of vehicle mobility through mobile traces is a wide area of study on its own which can branch in many fields of study \cite{Steenbruggen2015}. 

In this dissertation we will focus on the topic of measuring traffic flow and predict how traffic increase along time by using mobile data usage. A combination of data mining and machine learning techniques will be used to devise a data processing pipeline. This pipeline will consume raw event data records containing cell tower locations and date time and then it zooms into the main areas of activity of users, plots routes between these areas and collects spatial grid aggregate data from daily trips done along these routes from thousands of users. The dataset which is produced from this pipeline is used to train and validate a predictive model using artificial neural networks.

\section{Aims and objectives} \label{section:introduction:aims_objectives}

The problem to be tackled by this research will be traffic congestion detection and also its prediction within a specific time window. Traffic congestion can be measured through aggregate functions exercised on areas with well defined geo-fences. Traffic hotspots' data is more static unlike the location of mobile users which is less accurately traceable. The trip trajectory of an individual when compared with traffic congestion at a given point is far more non-deterministic \cite{Jarv2012}. Data aggregation of multiple users against time will produce more accurate results when predicting waiting times at a traffic hotspot then when trying to predict the trip for a given time interval and specific mobile user.

Traffic congestion analysis is tightly linked to a long list of factors. These factors are related in some way or another to mobile network determined location. It is not however excluded that the dataset is further augmented. Such factors or 'features' as most often referred to in applied artificial intelligence jargon might include but are not limited to are: number of exits at a junction point, distance from the nearest busy(a standard threshold is to be chosen on what defines 'busy' ) junction point, aggregate statistics of currently moving mobile users, historical trajectory data for drivers in the area, actual day of week, seasonality (whether it is a holiday or schools are closed), current infrastructural works which might skew the analysis, accidents records to correlate anomalies etc. Techniques that will be used as a traffic congestion metric is count of moving users per spatial bin at a given point in time\cite{Alarabi2014}. Spatial bins are geo-fenced areas in a rectangular format that enclose geospatial information. Frameworks such as Spatial Hadoop facilitate parallelized processing on large datasets in order to group data points in spatial bins for further analytics \cite{Alarabi2014}. 

We propose a systematic approach how to address the problem often stated in literature related to mobility patterns \cite{Calabrese2013,Toole2015,Hoteit2014,Alexander2015}. We are aiming to devise an accurate metric of traffic congestion and be able to forecast traffic through a model trained and tested with available mobile usage data. The real challenges resides in achieving granularity when modelling traffic given that mobile usage records' geolocation dataset is sparse and reveals the position of users with a considerable margin of error \cite{Hoteit2014,Gonzalez2008}.

\section{Dissertation outline} \label{section:introduction:dissertation_outline}
This dissertation started with a section that introduces the reader to the vehicular traffic problematic nature. It continues by expanding the socio-economic impact of traffic and how it can be addressed with modern technology. At the outset it is mentioned how mobile data usage has great potential to monitor traffic conditions and to predict it across time. The following chapter "problem definition" will discuss how the problem at hand of measuring traffic and predicting from mobile usage data is not trivial. It will show where the main challenges reside in order to arrive to a viable solution. Background on traffic flow detection and prediction and an overview of related literature will be given in chapter \ref{background} "Background and literature review". The proposed method to showcase selected implementations of certain concepts inspired by literature will be elaborated in the "Methodology" chapter.  Validity and versatility of the created model will be evaluated in the "Evaluation and Results" chapter. Finally the "Conclusion and Future works" chapter will summarize what has been achieved in this work and to what extent.  In this chapter shortcomings of the proposed solution will be discussed and possible improvements and prospects for the future will be listed.





\section{Problem definition}
From this research it is required to demonstrate that it is possible to attain an accurate measure of traffic and predict traffic for different amounts of time ahead. It is required to prove that this can be possibly done by constructing a predictive model and make use of inference techniques that base themselves on data usage records collected from the mobile cellular network. As we will expand in chapter \ref{background}, the trajectory path plotted by the mobile antenna through which users are given service is far from being a true picture of the actual path of the user.  An algorithm must be devised to deduce the actual path travelled by the user for his most common trips. The predictive model must possibly predict the traffic in a reasonable amount of time since a prediction that take a long time to compute will become futile in its purpose.


\subsection{Research Questions}

Research will be done in a direction outlined by the questions below:
\begin{enumerate}
	\item How is it possible to extract the geolocation of main areas of activity from user's mobile data usage records?
	\item What is the best approach to analyse traffic flow over time in space? Is the resolution of mobile data usage cell tower location fit for purpose to measure vehicular traffic flow on the road network?
	\item Is it possible to model traffic flow over time with machine learning techniques that use mobile data usage or processed data derived from it? From how much time ahead can the model predict traffic flow with an acceptable margin of error in such a way that the prediction is useful and practical for trip planning and traffic management systems?
\end{enumerate}



\chapter{Background and Literature Review} \label{chapter:background}

This chapter will go over mainstream techniques and approaches that make use of mobile data for traffic flow detection and prediction.

\section{Mobile location data sources} \label{background_mobile_location_data_sources} 

Mobile location retrieval include various sources. User locations have to be recorded from cell towers mainly for billing purposes. Other records are generated when there is a location update and hand over information \cite{Calabrese2011}. Geographical coordinates of the cell tower are added with billing information. Call data records (CDR) or event data records (EDR) as they are generically referred to when they comprise other forms of activity other then calling are generated by network elements to capture and report user activity within the network. Reporting frequency and record triggering events can be configurable, allowing operators to trade off between keeping at their lowest the quantity of generated records that are hungry of storage resources and providing enough data for billing/troubleshooting purposes.
Mobile internet is the service that generates most records. As soon as the user connects to the network, a first record is generated, providing all of the available information, including which cell tower is providing the service. Since data sessions span over a long period of time, periodic updates are required, allowing billing related entities to decide whether the user may continue to make use of the service. These updates may be triggered by either of the following:
\begin{enumerate}
\item Volume - a new record is generated as the user consumes more than a pre-configured volume.
\item Time - if the user is idle, a new update record is still generated after a specific amount of time from the previous record.
\item Network Trigger - operators may decide to generate a record each time there is a specific change (for instance, a change in radio access technology)
\end{enumerate}
	
Together with call records, SMS records (messaging) and data traffic (2G/GSM, 3G/UMTS, 4G/LTE) records can also be stored. SMS records structure are similar to those of CDRs \cite{Calabrese2013}. A call data record structure would include the A-party (who is calling), the B-party (the person who is receiving the call), call duration, date and time of calls amongst other things which might not prove to be useful for location deducing purposes. The location is implicitly the sector of the base station antenna which was managing the call/sms and where ultimately the CDR has its origin. The technology of mobile data transfer (2G, 3G or 4G) the user device makes use of is negotiated depending on the strength of the signal and load of cell tower \cite{Liu2014}. The technology used will fail-over to a less faster one but stronger in signal strength if reception experienced by user weakens (example changeover from 4G to 3G and so forth). This has an implication on location detection as we will see later on. A data event record would include volume of transmitted data in the session.

Mobile device location traces have their limitations when used for vehicular traffic analyses. In contrast with surveys they lack demographics \cite{Calabrese2013,Colak2015} and market share of the mobile service provider that made the dataset available for scientific research might not be really representative of the commuting patterns \cite{Calabrese2011}. Many studies mentioned that it is important to remove bias in preprocessing of such datasets before any further processing is done \cite{Iqbal2014,Toole2015}.  Passive data gathered in the form of CDRs are not suited to extract different modes of travel, route assignment and classify detailed activity types \cite{Colak2015}.

Mobile device location data is not only limited to data that originates from cellular networks. Global positioning system (GPS) is the most reliable source of geolocation because of its higher resolution with lower margin of error. This data is generated on the device and needs to be stored and communicated from the user's mobile with his own specific authorization. Using GPS data for a mobility study is more challenging because it needs the consent of users to get such data and drains the battery really fast especially because of long signal acquisition time \cite{Wang2012}. Thus users would be reluctant to have such service running in the background on their mobiles all the time \cite{Ahas2011}. 

CDRs were the most commonly mobile location data source used in recent research \cite{Hoteit2016}. The intention of our research is to use data usage EDRs since these can have a higher temporal resolution. A CDR can be more commonly generated when a user is not moving unless he is using hands free in his car. CDRs therefore would be more suited for home and work location detection whilst data usage records would be more generated frequently both when user is moving and stationary. To our best knowledge up till today the trend is to use CDRs. There are very few research projects that rely on mobile data usage to detect vehicular traffic or predict it. Few examples in literature are  \cite{Hoteit2014,Calabrese2011}. 

Other sources of geolocation include social mobile application recorded events such as check-ins in facebook \cite{Hoteit2014}. Such data can be accessed by available APIs.

\subsection{Data format and sample structure used in literature} \label{methodoloy_sources}


It is important to analyse in depth the structure of mobile records dataset sample and the method of collection thereof in order to understand possible limitations and strengths in related research. Another topic of special interest is the use of secondary datasets used to validate results achieved modelling travel on mobile generated data. Hoteit et al utilized mobile data coming from 1 million users between July and October 2009 \cite{Hoteit2014}. The data consisted of calling and messaging parties' anonymous id together with data of when users make a data connection. Interestingly in \cite{Calabrese2013} together with data collected from the CDRs (a sample of 1 million mobile users in Massachusetts) which contain calling id, time of when call/sms is done or received and when a data session is initiated, vehicle safety inspection data is used as part of the study. This is later used to verify approximately the kilometres covered when inferred from the trajectory computed based on the user data points. Time window is 3 months long and area covered is metropolitan Boston.  \cite{Calabrese2013,Colak2015} stressed several reasons why surveys have a lot of disadvantages when compared to mobile device generated data including sample size which is smaller, update frequency and certain types of time windows that are seldom considered or not captured by surveys such as seasonality, public holidays and weekends.   

In \cite{Gonzalez2008} two datasets are used. First sample is of 100,000 individuals sub-sampled from a wider dataset population of 6 million anonymized  phone users. Again data used was id of device from which calls or sms originated or terminated and location of tower projected over time. Average area covered by cell tower was 3 km$^{2}$ with 30\% of cell towers having a coverage of 1 km$^{2}$ or less. The other dataset consisted of 206 mobile users whose location was traced every two hours for a week. The second dataset individuated irregular calling patterns noticed in the first one. Then displacements were recorded for consecutive calls in order to construct a distribution model.

\cite{Hoteit2016} use two datasets which have GPS location of 86 mobile users in various places in the world. One dataset is generated by sub-sampling the original one in order to emulate a sparse CDR dataset. Authors were forced to do this since no real CDR dataset was available for their research.  

Two different examples of tools have been found to be employed to aggregate location data. Airsage datasets were found often to be used in literature \cite{Hoteit2014, Wang2013, Calabrese2013,Leduc2008,Wang2012, Colak2015}. Basically airsage does not simply just record the tower cell sector but depending on a refined triangulation algorithm it gives a more precise location.  \cite{Hoteit2016} makes use of MACACOApp which is an app that records mobile data usage but most importantly also GPS data. As already aforementioned GPS technology gives a more accurate geolocation. However the data sample size is much more on a minor scale than that collected from raw cdrs in other studies.

\subsection{Mobile position inference from Floating cellular data} \label{mobile_inference} 

The method that makes use of mobile data connectivity with base stations is commonly referred to as floating car data or more specifically floating cellular data (FCD) for sensor data originating mainly from cellular networks. A specific technique to actually determine a user's location is based on triangulation as done by the Airsage solution \cite{Hoteit2014}. Proprietary algorithms process data received from mobile service providers and outputs refined location information to customers. It was reported that in testing carried out by Geostat Inc. Airsage got accurate classification of congested traffic 91\% of the time  \cite{Wang2012}. No technical background was made available how these algorithms get a more precise location of mobile users and this is most likely attributed to the fact that algorithms are patented.  It is stated that Airsage location computation accuracy is within 200 to 300 metres in \cite{Colak2015}. \cite{Calabrese2013} states that the degree of precision reported by AirSage is an average of 320m and median of 220m. As already aforementioned AirSage has been used in \cite{Hoteit2014} as well. In comparison \cite{Gonzalez2008} simplistically mentions that 30\% (average is \(3km^{2}\)) of the towers are placed in a density of 1 tower per square km. This roughly would mean that at most an unprocessed location retrieved from cellular location data would have a maximum error of around 500m. 

Therefore antenna/mobile tower location to which the mobile users connect with, may not be useful for all intents and purposes since it might be hundreds of metres away from the actual position. In our research we cannot make use of Airsage datasets. Such solutions must be already in accordance with local mobile network operators and currently there are no such agreements with the local providers. Therefore in this research some effort had to be dedicated to devise a simple triangulation or clustering method that can achieve more accurate mobile user location than the actual cell tower location. Since the grouping of multiple mobile users within a grid of location cells would prove to be more efficient in accurately measuring levels of traffic an essential topic to treat in traffic congestion research is spatial binning. Spatial binning basically provide geographical aggregate statistics.  MapReduce frameworks such as Spatial Hadoop exist so the expensive temporal geospatial analytics are done within an acceptable time window \cite{Wu2014,eldawy2015spatialhadoop}. Such tools would even provide the possibility of doing spatial joins that can correlate spatial features extracted from sources such as OpenStreetMaps with mobility data from a mobile usage dataset \cite{Alarabi2014}.


\section{Privacy and data anonymization} \label{data_anonymization} 


Mobile subscribers location is highly sensitive so anonymization has to come into play if legal issues are to be avoided when handling data for research purposes. For instance \cite{Laurila2012} exposes facts regarding potential privacy breach risks within datasets that have unique identifiers hashed. Methods that adds to anonymization efficiency listed in \cite{Laurila2012} are contractual binding of data users to not reverse-engineer identity together with truncation of data if in a given area enough data is available. Also \cite{Laurila2012} gives a detailed account of techniques used to hash unique identifiers. \cite{Shin} elaborates on how to use k-anonymity algorithm so that location data of a user makes his identity undistinguishable from other k-1 other users in the same region.

Another way to guarantee privacy is limiting data retention. To safeguard privacy travel paths of a specific mobile user is kept for not more than 1 day in \cite{Hoteit2014} and 2 days in \cite{Calabrese2013}. It is the norm to assign a hashed anonymous identifier to each mobile user in such method as well.

%TODO - re-identification - https://iapp.org/news/a/looking-to-comply-with-gdpr-heres-a-primer-on-anonymization-and-pseudonymization/


\section{Big Data, the cloud and large scale real time stream processing} \label{background_big_data}

Computing systems could not hold the pace of the vast increase in storage requirements \cite{Liu2014}. The bottleneck have been always IO reads and while cpu processing power and disk read speeds increased, data volume related to big data problems increased at a faster rate. 

Big data frameworks are suited for such scenarios. It shards the volume of data on a cluster of nodes and makes the addition of a new node in the infrastructure seamless. Failure of a node will not disrupt an ongoing computation since data will be redundant in other blocks of data replicated on other nodes in the cluster. Replacement of failing nodes is also a smooth operation in big data infrastructure. The main shift of the high performance architectural change was not how to distribute data in the network because this alone would increase network communication latency. It resides in offloading processing to the nodes where the data is located and only the resulting required information is transmitted back to a centralized node where the driver program is.

When is the data infrastructure of a system in need of a shift to the Big Data paradigm and traditional RDBMS systems cease to be effective? When you have the 3 V's which are volume, velocity and variety in the data its a recipe for big data introduction as a part of the solution. This is quite applicable to the processing of the multitude of mobility data which comes in huge amounts and need to squeeze out information in the least amount of time. Our dataset that was collected between August 2016 and September 2017 is 150G in size. Building a predictive model on this dataset of such size and retrain in real-time would require a big data solution. Currently some of the leading frameworks in this area are Hadoop and Spark. Hadoop is treated in detail in \cite{Liu2014} and revolves around the mapreduce programming model. This work shows how enormous amounts of data is stored in a distributed fashion on HDFS (hadoop file system) which is highly scalable and fault tolerant. Spark is used extensively in lambda architectures that include both nightly batch and real time batch processing. \cite{Liu2014} might not be that related to the analysis of mobility behaviour but describes well how to process mobile device generated data traffic. It also gives a good account on how to monitor the infrastructure through various metrics and tooling. There are many papers related to mobile user travel pattern prediction that make use of big data innovation  \cite{Liu2014,Laurila2012,Kurien2012}. \cite{Toole2015} states that dataset size can be an issue for computation when determining the OD matrix. In this same study parallelization is used to assign routes to trips.


\section{Origin and destination matrices computation} \label{section:OD_Matrices}
A consistent recurrence in traffic flow analyses literature is the study of how to deduce origin and destination (OD) locations for travelling vehicles\cite{Iqbal2014}. Many research articles confronted the problem posed by traffic congestion detection by first deducing the OD matrix \cite{Toole2015,Iqbal2014,Alexander2015,Calabrese2011,Calabrese2013,Colak2015}. In \cite{Alexander2015} OD matrices are used to generate trips and hence also give an accurate analysis of travel patterns. in \cite{Iqbal2014} the OD matrix extracted from mobile usage data is scaled up to generate an more representative OD matrix and a simulation is carried out in order to compare with traffic counts readings collected in surveys.

ODs are used to extract main activity hubs. \cite{Gonzalez2008} states that 40\% of the time users are at their two preferred locations.  Therefore most trips can be mostly explained as being  between several locations since users tend to be highly inclined to be regular in spatial and temporal terms. All this leads to safely assume that the majority of trips are between home and work. In literature it  is commonly found that locations that were likely to be recorded in OD matrices were home and work \cite{Calabrese2011,Colak2015}.  In \cite{Calabrese2011} home location is detected for user by checking which 500 metres square cell has the most activity during the night for every specific user.

\cite{Colak2015} labels zones such as home and work and tries to find purpose behind other types of trips. \cite{Colak2015} mentions how ODs are analysed in terms of stays and trips. Frequency of calls and time of day determine the labelling of these stays. It was not possible to categorize other types of stays other than home and work. So these types of stays are generally labelled as other.
\cite{Calabrese2011} puts forward the concept of virtual location which is derived from fused visited locations by the user. Calabrese devises an algorithm which localizes the centroid of important locations in a user trip that are to be labelled as the origin or destinations of particular users \cite{Calabrese2011}. The method analyses which points are in the proximity of others within a 1 km radius. 

A common occurrence in literature is to remove users that do not make enough usage. The behaviour of these is less predictable and its more difficult to generate trips from OD data. In \cite{Toole2015} users that do not make enough calls are filtered out from dataset and \cite{Colak2015} filters out users with low activity when labelling activity zones. 

Displacement errors due to sudden change of cell tower for various reasons are reported to make datasets inconsistent. \cite{Iqbal2014} reduces false displacements by using a time window of 10 minutes. The most common location in the 10 minute window was considered the actual location. A time window of 1 hour is than used to detect trips. In \cite{Calabrese2011} a low pass filter is used to minimize localization errors. To reduce sudden movements due to cell tower handover clustering is used.  \cite{Colak2015} raises the concern in a similar fashion and says that CDR data contains jumps or oscillations which is noisy. \cite{Colak2015} mentions how Airsage dataset inherently provides triangulation that gives medoids as processed data. Filtering out of noise in a Rio de Janeiro CDR dataset is done by labelling stays only if records are registered for a user for more than 10 minutes. When observing stays for users for a long period of time it is possible to get more clear patterns where the stays are actually visited by users or not. \cite{Toole2015} removes noise from mobile phone calls deduced trajectories by using the stay algorithm proposed in \cite{Zheng2011}. A 'stay' location is recorded whenever user makes a set of calls with a time window greater than a given threshold. Centroid is then calculated for set of locations that are close to each other in order to compute a better approximate location of the user. \cite{Iqbal2014} mentions that Estimation of OD matrices can be unreliable because of sampling bias. Equally \cite{Toole2015} stresses that bias needs to be removed when constructing OD matrices.

An important attribute to consider in OD matrices is its resolution since it might be important to aggregate data for statical purposes. Very few information has been found in literature on this. In \cite{Colak2015} census tracts and town boundaries are chosen for OD resolution. No justification for this choice is given tough.

Scaling methods are often used to get OD matrices that reflect reality better. In \cite{Iqbal2014} scaling factor Beta is used to get the actual OD matrix for traffic flow. The scaling factor is obtained by inputting optimization formulas, route choice probabilistic models, network data and the OD matrix in a simulation engine. The scaling is then distributed as shown in \ref{OD_scaling}

\begin{equation}\label{OD_scaling}
\textit{OD}_{ij} = \sum _{ij} (t - OD_{ij}) * \beta_{ij} 
\end{equation}

Problem is then simplified to calculate scaling factor for a set of groups based on dataset analysis rather than for every single OD.

\cite{Colak2015} uses the iterative proportional fitting (IPF) upscaling method. Here Colak determined the expansion factor for each tract and in the IPF took in consideration trips to destinations as well. In his conclusions Colak stated that the IPF Procedure to distribute user CDRs according to population might have been too simplistic of an approach.

Route selection is tightly knit as a product of OD matrices and when linked they are commonly referred to as OD trips. In \cite{Iqbal2014} route is mostly determined by a function of least travel time path. In \cite{Toole2015} Open Street Maps (OSM) which is an open source map building framework is used to infer routing. Some studies assign trips to a user when there are consecutive calls in the same day and the calls are done from different locations. Two consecutive 'stays' that are not more than 1 day apart would constitute a trip \cite{Colak2015,Toole2015}. OD matrices determined trips would not be sufficient to model traffic on a network. Microscopic traffic assignment dependent on these trip generation exercises needs to be modelled. \cite{Toole2015} for instance implements incremental traffic assignment (ITA) in which trips are added to network incrementally. Then on each iteration routes are assigned according to capacity saturation of roads. It is admitted however that Wardrop’s equilibrium  adapts better since routes are changed dynamically depending on congestion. However ITA algorithm is chosen because it is simpler to implement. \cite{Colak2015} relies on probabilistic model for traffic assignment. Departure times for trips are set according to pre-set distribution of departures.

Traffic flow metrics can be explained in terms of vehicle count per \textit{t} amount of time or even in a more descriptive way with a metric that measures travel performance as volume over road capacity V/C \cite{Toole2015}. The latter metric has more information since a road with low capacity may be more congested than another that has the same rate of traffic flow but a higher capacity. In a more elaborate metric proposed by \cite{Toole2015} a road can be possibly classified as a function of betweenness and usage. Classes are defined as connector (high betweenness and high usage), attractor (low betweenness and high usage), peripheral (high betweenness and low usage) and local (low betweenness and low usage).

Validation related to OD matrix generation is generally done by correlating the generated locations and trips to survey data. In \cite{Toole2015} survey data traffic load on road network is compared with that generated through OD matrices formed from mobile CDRs. Simulation generated routes for the latter have been produced with the ITA approach. \cite{Toole2015} states however that other methods should be further explored to removed uncertainty from the proposed techniques.

In \cite{Iqbal2014} traffic count was collected on a spread of 3 days in 13 locations and this data was used for calibration of the system.  For validation another day was used with 4 different locations. Prediction root mean square error (RMSE) and root mean square (RMS) percent errors were 335.09 and 13.59\% respectively. In \cite{Calabrese2011} evaluation was done against a tract by tract census. Euclidean distance was calculated and the distribution of the trip distance confirms Gonzalez affirmation that trips follow a random walk \cite{Gonzalez2008}. See equation \ref{label_random_walkabel}

\begin{equation}\label{label_random_walk}
P(x) = (x+14.6)-0.78^{-x/60} with R2 = 0.98  
\end{equation}

Here euclidean distance added error and to portray visually, although it might prove to be simpler, it would not give more insight on the road infrastructure use. In the OD trip analysis done by \cite{Calabrese2011} it is estimated amongst other things that a user makes 5 trips on weekdays and 4.5 during the weekend. This matches approximately the US census data which is 4.18 during weekdays and 3.86 on weekends. Study concludes that the OD matrices that are produced with the proposed methods can be of great value to those who are responsible for traffic planning.

\cite{Colak2015} carries out validation against traffic surveys and already available OD matrices from department of transportation.  However only morning sample was used for validation. \cite{Colak2015} boasts of trip generation and attraction correlation near to 1 for both cities in study namely Boston and Rio de Janeiro. The correlation with already validated datasets is highest when OD matrices are generated from aggregations done on larger polygons. \cite{Colak2015} reports OD matrix limitations. Suitability of CDRs to determine ODs is only good at a certain resolution. Best to have higher resolution for home or work location detection and aggregation within larger zones (towns or districts) for OD trips representation. OD matrices are less fitted to get information on the whole travel model which for example includes modal split information.


\section{Graph databases and Parallel graph processing}
In traffic congestion research cross-sectional snapshots of data are of little use. Historical data hoarding is imperative in order to chisel out patterns of commute and classification of traffic patterns in every region within a set of given boundaries.

Nowadays the data encountered in many IT systems' scenarios got too voluminous in such a way that normal traditional RDBMSs could not handle any more in terms of both model and performance.  NoSql entered the scene in the last ten years to cater for new challenges and together with Big data it helped to address issues such as requirement to store unstructured and semi-structured data in a schema-less form, need for high-scalability, low-latency and high performance. NoSql however has its drawbacks as well. Most of the NoSql solutions do not support ACID transactions in order to keep data consistent for example.  

Graph databases use native storage and native graph processing. They were designed to process data mining related to graph  better than relational databases. Relational Databases are most suited for problems that are well defined at the start of a project. A clear sign when to use graph database is when designing the schema it appears that a lot of joins will be needed. Graph-parallel computation gives an edge when processing is shifted on each data node of the graph. Referential integrity although useful for data integrity as the name implies comes at a dear cost. Queries and data manipulation that involves joins are slower.  Mining of highly relational entities such as mobile users location in the traffic network and the streets map make graph databases such as Neo4j an essential tool. Destination matrices should also be stored in Graph databases. Offline graph processing frameworks such as Giraph or Spark Graphx might then be useful to carry out scheduled jobs for collating information such as shortest paths and estimations of travel duration from any point A to any point B in a map grid.


\section{Model fitting to human mobility} \label{methodology_modelling}
Mathematical modelling of human mobility is important to predict with a stated certainty the location of a mobile user in time since data collected from mobile devices is sparse. Interpolation methods were used to describe human mobility patterns in \cite{Hoteit2014}. These are namely linear-interpolation, nearest-neighbour interpolation and cubic interpolation. Linear-interpolation would simply project the mobile user position at time (t) by plotting a straight line from the last previously recorded location and the one right immediately after. This method's error margin is widened if the recorded data sample are distant in what is time interval. As for the nearest-neighbour method location is placed to the previous recorded value or to the subsequent depending which is nearest on the time axis. The cubic interpolation is best explained when contrasted with the linear one. This method as perfectly stated in \cite{Hoteit2014}  is described as "shape preserving". The slopes shaping the curves are deduced from derivatives and give a less sharp demarcation and better guess depending on a series of data samples.

In \cite{Gonzalez2008} both the variation of displacements for consecutive 'steps' (call location) and the radius of gyration distribution was modelled as truncated power-law which is referred to in all the work as a levy-flight (See figure. \ref{fig:levy_flight} and equation \ref{displacement_distribution} for illustration of displacement distribution modelling). 

\begin{equation}\label{displacement_distribution}
P(\Delta r) = (\Delta r + \Delta r_{0})^{-\beta}  exp(-\Delta r/\kappa)
\end{equation} 

with exponent $-\beta$=1.75 $\pm$ 0.15 (mean $\pm$ standard deviation), $\Delta r_{0}$=1.5 km and cutoff values $\kappa|_{D_{1}}=400 km$ and $\kappa|_{D_{2}}=80 km$ 

\begin{figure}[h]	
	\includegraphics[scale=0.75]{truncated_power_law}
	\centering
	\caption{Truncated levy flight human motion modelling. Reproduced from \cite{Gonzalez2008}}
	\label{fig:levy_flight}
\end{figure}

This mathematical model is cited and verified in \cite{Calabrese2013}. Methodology adopted in \cite{Hoteit2016} suggested approaches how to determine home and work locations, span of movement and complete trajectory. Two datasets were compiled. The second one is a sub-sample of the first which is composed of GPS geolocation data. The sparsity of the second dataset have been mimicked by a cumulative distribution function in order to create a virtual CDR dataset. Only users with high activity were considered in order to have less irregularity. Home and work locations were determined with a mode function with catch-all time boundaries for day and night where supposedly users are either at work or home respectively. For span of movement a similar mathematical approach was adopted as the ones in \cite{Hoteit2014,Gonzalez2008}. As for the actual movement trajectory error was calculated by calculating the euclidean distance of each CDR data-point from the actual GPS recording which is nearest in time.
Some techniques were used to lessen the margin of error. Since most of the time the typical mobile phone user is static, data completion is attained by applying a list of inference rules for which different results are achieved when estimating users location, hence the name of the paper "filling the gaps".

An issue have been raised in \cite{Calabrese2013} about detecting a lot of trips in very short distance which do not tally with statistical data given by surveys. This is explained as being caused by fluctuating random connections with towers which spatially misplace the user when in reality he is not actually physically moving. This issue was tackled by mathematically creating so called by \cite{Calabrese2013} 'virtual locations' (a mass/group of traced positions in a given radius of Airsage resolution) and actually recording a movement when user moves from a virtual location to the other. Calabrese limits static location detection to the home location and the process how to manage to get each user's location is similar to that expounded in \cite{Hoteit2016}. In a novel style this work studies the relationship between total trip length calculated from mobile phone location data and vehicle kilometres travelled (VKT) and urban features such as entropic type, population density, intersection density, average distance to non-work destinations, distance to subway stations and highway exits. These urban features were derived from US Census of 2000 and activity travel surveys.

Estimation of load error is proportional to concentration if users in a given block \cite{Hoteit2014}. When error is less than 1 km a probability of 80.78\% of being within commonly travelled territory contrasts with a probability of 19.22\% when user travels outside of it. From the opposite perspective the probability of being inside radius of gyration given error is high at 40.25\% and that of being outside is 59.75\%.

\cite{Calabrese2013} boasts of 49.40\% of mobility variation can be explained for individual mobile users and 56.48\% for vehicle associated mobility in terms of trip length.    

In \cite{Gonzalez2008} results point to the phenomenon that the greater is the radius of gyration the less symmetric in shape is the probability density function which gives the probability of a user being in a given location (x,y). Also the margin of error increases similarly as stated in \cite{Hoteit2014}. It is also shown how individual mobility is well described by a levy-flight. Also a probability density function has been implemented to give the likelihood a user is at a certain given place in time.

The techniques used to further refine the location based on the assumed location home interval gives results in the range of 92\%-95\% of cases within 100m \cite{Hoteit2016}. Techniques will produce large errors (in the range of 50km) when user travels long distances and may not return to home location during the usual time interval.

Error distance from trajectory depends on radius of gyration \cite{Hoteit2014}. Interpolation methods are found to be most suited depending on distance from centre of mass. Nearest neighbour is most suited for $r_{g}$ less than 3 km. Between 3 km and 10 km both linear and cubic interpolations perform well. For commuting travelling patterns trajectory is best estimated with a cubic interpolation.
Interesting insights are contributed in \cite{Calabrese2013} where it is stated that job accessibility and distance to non-work destinations are inversely proportional to total trip length. Distance from subway does increase trip length for individual mobile users but it does not impact vehicle use. This means that subway commodity does not necessarily decrease vehicle use in the surrounding radius. Vehicular trip length decreases when correlated with increase in intersection density but not so for individual mobile users. Urban entropy and population does significantly impact trip length. Thus this study can help a lot in urban planning and large scale policy making.
\cite{Hoteit2016} affirms that the solution of data completion augmented by the placing of users in their home location at inferred intervals of time produces better results then what was achieved in literature.

There are many approaches in literature how to classify group mobility patterns under specific categories.
\cite{Hoteit2014} segments mobile users depending on how much stretched is the radius of gyration (\(r_{g}\)). The different distinguished categories of users are listed as sedentary, urban, peri-urban users and commuters. Classification boundary was decided upon steep changes in the cumulative distributed function of the radius of gyration. Respectively they fall in the ranges \(r_{g} <= 3km, 3km < r_{g} <= 10km, 10km < r_{g} <= 32km, 32km < r_{g}\). This radius of gyration (see eq. \ref{radius_gyration}) is the notion outlined by the sum of all displacements from the centre of mass divided by the number of trips. This parameter describes how distributed are the trips far away from the zone where the user mostly frequently returns. Repeated utilization of this mathematical notion is found in \cite{Hoteit2014,Gonzalez2008,Hoteit2016}.

\begin{equation} \label{radius_gyration}
r_{g} = \sqrt{\sum _{i=1}^{n}({\stackrel{\to }{p}}_{i}-{\stackrel{\to }{p}}_{centroid})^2}
\end{equation}

where 

\begin{equation}
{\stackrel{\to }{p}}_{centroid} = \sum _{i=1}^{n}{\stackrel{\to }{p}}_{i}
\end{equation}

In \cite{Hoteit2016} the hypothesis that an individual tends to be found with high probability at his home or place of work makes the authors to come out with so-called 'stop-by' categories. The stop-by categories are stop-by home which is demarcated by the night time interval where a user is expected to be at home. stob-by-flexhome is a refinement over and above stop-by-home were night time interval varies per user. Stop-by-spothome fills data lacunas or corrects errors when there are exceptional errors where user is expected to be in home location as indicated by previous category.


\section{Prediction methods}

{works in progress}

Prediction of traffic results have to take in consideration where the model is being used for forecasting. \cite{Sommer2013} states for example that it is easier to predict traffic in highways rather than in urban areas since traffic tends to be smoother.

%TODO - important



\chapter{Methodology} \label{chapter:methodology}

One of the main objectives was to extract meaningful features from mobile data usage that would serve as the basis to build a traffic flow model. Before choosing an approach and construct an algorithm to use in order to map raw data and translate it into traffic flow metrics a thorough familiarization exercise with the data was due. A feasibility check had to be carried out on whether it was possible that by devising an algorithm a direct relationship is established between mobile usage data and traffic flow. If data would have proven to be too sparse, both temporally and spatially,  augmentation of mobile usage dataset by tapping into other datasets would have been necessary. Such  datasets could include ANPR data collected from video streams, call data records available openly on the internet, accident reports and anything related to road transport which would convey information on human mobility patterns. In this chapter we will elaborate how we investigated certain approaches and how we decided to dig deeper with some chosen techniques rather than others depending on how practical the solution was and how it would give a better result.

\section{Mobile data collection and structure} \label{section:methodology:mobile_data_collection_structure}

The anonymized dataset was provided by GO Plc Malta which is one of the main data providers. The dataset recorded ranges from October 2016 to September 2017 which is a full year of data. However it was decided to concentrate only on the month of October 2016 so that analysis and model learning is faster by working on prototypes tested on a sample of the data. Results were considered to be satisfactory even though it is known that for certain machine learning  algorithms training with more data would probably give better results. Number of distinct cells amount to several thousands but distinct cell locations amount to only a few hundreds since a cell tower shares antennas for different technologies. Precise figures cannot be disclosed due to commercial sensitivity.

As stated by the provider of the dataset, EDR/CDR records are generally buffered to file on the network element. Files are closed periodically, generally every 1 to 5 minutes. Files are then collected and processed by the mediation platform, which parses, enhances, and extracts all of the necessary information from these records. New files are then sent towards billing and other entities as per required. It normally takes around 10 minutes for an EDR/CDR to be within the data-warehouse, hence available for further processing. However mobile operator engineers stated that polling frequency can be increased as needed. A smaller polling interval would allow to have predictions closer to reality.

Unique data usage users amount approximately to 108 thousand for the month of October 2016. This month was chosen for its' heavy traffic characteristics because schools start in their full sway and university students start to travel with their cars adding to the load of traffic. This sample would be roughly representing half of the provider's subscriber base which is just over 200 thousand. This figure was derived from all the distinct users that make calls or use data. Therefore the number of data users that are in the sample is roughly half of the whole set of users. One must take note however that all these data users in this study might not necessarily contribute in a directly proportional manner to the number of vehicles on the move at a certain point in time. There might be static users, users who are just passengers in the car, users that have more than one device and other users that make use of other means of transport. All these facts must be taken in consideration when setting up the proposed solution and evaluating results. The records' data structure is shown in table \ref{table:dataset_01}.

%TODO - Here to correlate with MCA data on data usage and subscriber base.

\begin{table}[h]
    \label{table:dataset_01}
	\centering
	\resizebox{\textwidth}{!}{

\begin{tabular}{|l|p{5cm}|c|}
	\hline 
	\textbf{Data item} & \textbf{Description} & \textbf{Example value} \\ 
	\hline 
	 A\_NUM & user hashed identifier. & 5a8bd7889fb3051b10f249a5554c803a \\ 
	\hline 
	TIMESTAMP & date and time of usage. & 2017-01-01 00:00:00.000 \\ 
	\hline 
	SOURCE & Type of Record. Data or Voice. & DATA \\ 
	\hline 
	CELL\_ID & Cell identifier & 3073 \\ 
	\hline 
	TOWN & Cell town & Paola \\ 
	\hline 
	DURATION & Duration of call or data session in seconds & 60 \\ 
	\hline 
	VOLUME & Volume of data used in session in kilobytes. 
	Applicable only for records of data usage. & 324.34 \\ 
	\hline 
	LONGITUDE & longitutidnal coordinate & 14.50664 \\ 
	\hline 
	LATITUDE & latitude coordinate & 35.87 \\ 
	\hline 
	RAT\_TYPE & Network technology & LTE \\ 
	\hline 
\end{tabular} }
\caption{Data Dictionary of mobile usage raw dataset} 
\end{table}


\section{Dataset preliminary analysis} \label{section:methodology:data_set_preliminary_analysis}

Total number of records of any given type for the month of october 2016 was 125 million. 78\% of these records are data usage records. This gives an indication that there is a four fold higher frequency data usage type record generation when compared with calling data records generate rates. This fact evidently gives an edge on other research that used calling data records as their data source since the frequency of users location recording is much higher. Higher temporal resolution would reflect better spatial resolution and both of these in combination will conduce to better results both when measuring traffic flow counts and when extracting main user activity hubs. Lower sampling rates lead to interpolation error. 

Table \ref{table:summary statistics} shows some summary statistics about the main unprocessed data set. Minimum and maximum timestamps show that data stretches from the very first minute to the last of the month being analysed. The total count of data usage records is 97 million. The basic data session duration  mean was approximately 16 minutes which was quite discouraging. This would entail that on average a wait of 16 minutes would be required to write to data storage a mobile cell EDR. This is not desirable for real time immediate future traffic count forecasts because the time for the detected departure is retrieved much later than it would actually have happened in such a way that predictions become useless. This would boil down to having a data session duration length which contributes to a considerable displacement error. Until the user connects to the next cell there is a distance covered within the average of 16 minutes and a standard deviation of 22 minutes which is also very high. For a vehicle driving at an average of 40km per hour this would translate to an average displacement error of 10km. 


\begin{table}[h]
	\label{table:summary statistics}
	\centering
	\resizebox{\textwidth}{!}{
		
		\begin{tabular}{|l|p{5cm}|l|l|}
			\hline 
			\textbf{Summary} & \textbf{timestamp} & \textbf{data session duration (s)} & \textbf{volume (Kb)}\\ 
			\hline  
			count & 97718761 & 97718761 & 97718761\\ 
			\hline 
			mean & null & 944.702465855047 & 1008228.7463008869 \\ 
			\hline 
			stddev & null & 1367.394246 & 3791128.444 \\ 
			\hline 
			min & 2016-10-01 00:00:00.000 & 0 & 0 \\ 
			\hline 
			max & 2016-10-31 23:59:59.000 & 3600 &  3.5590011E7\\ 
			\hline 

	\end{tabular} }
	\caption{Basic summary statistics of main EDR dataset.} 
\end{table}


When a frequency diagram is plotted an interesting fact comes out (see figure \ref{fig:data_session_duration_bin_count}). 15\% of the EDRs have a data session duration value of 1 hour. This duration is the limit set by the telecommunications provider for a mobile usage EDR. These records are generated for users who are not moving. Records with such duration were filtered out for a better summary statistics exercise since the main focus is on records that are related to movement. As a consequence more precise statistical information was acquired which describes better the possible level of displacement error and how long does it take to register the first record after a user moves from one location to another.

\begin{figure}	
	\includegraphics[scale=0.75]{data_session_duration_bin_count.jpg}
	\centering
	\caption{At the right of the plot one can notice a spike of records on with data session duration of 1 hour.}
	\label{fig:data_session_duration_bin_count}
\end{figure}

After removing 1 hour duration EDRs newly calculated summary statistics show that the mean and standard deviation are decreased down to 8 minutes and 14 minutes respectively. This is a 50\% gain with respect to previous statistical data. Further looking at the data, by overlaying a cumulative distirbution it is shown that 80\% of the records are below the 5 minute mark. These data facts have to be all taken in consideration when assessing the usefulness of the prediction results in evaluation and results chapter \ref{chapter:evaluation_and_results}. 



\begin{table}[h]
	\label{table:summary statistics_02}
	\centering
	\resizebox{\textwidth}{!}{
		
		\begin{tabular}{|l|p{5cm}|l|l|}
			\hline 
			\textbf{Summary} & \textbf{timestamp} & \textbf{data session duration (s)} & \textbf{volume (Kb)}\\ 
			\hline  
			count & 82589696 & 82589696 & 82589696\\ 
			\hline 
			mean & null & 458 & 1094048 \\ 
			\hline 
			stddev & null & 827 & 4031503 \\ 
			\hline 
			min & 2016-10-01 00:00:00.000 & 0 & 0 \\ 
			\hline 
			max & 2016-10-31 23:59:59.000 & 3599 &  35590011\\ 
			\hline 
			
	\end{tabular} }
	\caption{Basic summary statistics of main EDR dataset after removing 1 hour duration EDRs.} 
\end{table}

 
 
 \begin{figure}
 	\includegraphics[scale=0.75]{data_session_duration.jpg}
 	\centering
 	\caption{80\% of the records are below the 5 minute threshold.}
 	\label{fig:data_session_duration}
 \end{figure}
 

%See notes in %https://onedrive.live.com/edit.aspx/DOCUMENTS/THESIS?cid=467740571959b235&id=documents&wd=target%28BIG%20DATA%20ARCHITECTURE%2FHIVE.one%7C19327BD9-4579-41F9-B4C8-2688BDD8650D%2FTRIPS%20BY%20DAY%20OF%20WEEK%20HOUR%7CA927A243-B669-4C3A-BD69-6FAF6E87251C%2F%29
%onenote:https://d.docs.live.net/467740571959b235/DOCUMENTS/THESIS/BIG%20DATA%20ARCHITECTURE/HIVE.one#TRIPS%20BY%20DAY%20OF%20WEEK%20HOUR&section-id={19327BD9-4579-41F9-B4C8-2688BDD8650D}&page-id={A927A243-B669-4C3A-BD69-6FAF6E87251C}&object-id={E4273ACD-1D2A-4BD6-A4DD-243496DEC6AA}&12


%TODO - number of sessions per hour for data users
%TODO - usage of data during the day and durng the night
%TODO - distribution of data usage (variance) per hour
%TODO - A graph that has average traffic intensity between 6.00am and 9.00am and 4.00pm and 7.00pm in the evening would be hgihly informative.



\section{Algorithm Selection} \label{section:methodology:algorithm_selection}

One of he most challenging tasks involved in this study was to assign vehicular traffic to the road network depending on surrounding cell tower traffic in a time series.

\subsection{Trajectory interpolation through cell tower data} \label{subsection:methodology:trajectory_interpolation}
The first approach that we tried to investigate was to relate the cell tower data by snapping it to the road infrastructure mesh depending from which direction the vehicle is coming. Various APIs are available to retrieve nearest road from an input geographical location\footnote{Google Snap to Road is an example - https://developers.google.com/maps/documentation/roads/snap}. We had no prior knowledge on how cell tower transmission is configured. There are many settings which might determine the range of the cell tower including frequency, rated power, height of tower etc. Given that such information was missing transmission range of the cell towers was an unknown variable. A possible  alternative to roughly estimate range was to calculate the average distance from the nearest \textit{k} neighbouring towers for all cell towers. However from a sample taken from the dataset available of the cell towers across Malta the variance seemed quite high, ranging from an inter-distance of 150m in urbanized areas to several kilometres in rural areas (Comprehensive cell tower locations map for all the country not being shown since it is sensitive commercial data). Further to this from the analytical perspective it was decided to plot the cell towers' on the map and check if their distribution pattern would make it feasible to snap a data record cell tower location to the nearest road or area polygon. Thus here it was taken as an assumption that the area around cell towers will be be given service with equal range from each tower. Allowance for overlapping was also taken in consideration. It is evident from figure \ref{fig:cell_towers_distribution} that a lot of roads would be included in the range of a cell tower so it would have been difficult to devise an algorithm to derive trajectories and traffic flow counts from cell tower location data. Given that there are a lot of unknowns including how handover procedure is handled in specific areas and the actual range of cell towers, the solution path of snapping to nearest roads depending on EDR coordinates was discarded. Such an approach would might have made it too impractical to assign traffic to junctions, roads or polygon areas and the probability of inaccurate results was high.

\begin{figure}[h]	
	\includegraphics[scale=0.75]{cell_towers_distribution}
	\centering
	\caption{Cell tower range distribution. Red dots are cell tower locations and dotted line is the estimated range.}
	\label{fig:cell_towers_distribution}
\end{figure}

\subsection{Traffic simulation from OD matrix} \label{subsection:methodology:traffic_simulation_ODMatrix}
Another approach would have been to simulate traffic by inputting statistical information on travel patterns retrieved parameters from the dataset. Possible input to the simulation based traffic model would have been an OD matrix that will be discussed in section \ref{section:methodology:clustering}. Toledo et al. \cite{Toledo2004} mentions that OD flows are an important input to simulation models but an accurate OD matrix is difficult to acquire. An example of such implementation of a simulation based on an OD matrix can be found in \cite{Hirai2015}. In this study electronic toll collection data is used to form an initial OD-Matrix. This OD matrix is further optimized by optimizing a model that gets observed detector data and a simulation based on current OD, computes the least cost difference and optimizes the OD matrix depending on result. This process is iterated until an acceptable coefficient of determination is achieved. Simulation models generally give two types of outputs namely a visual simulation of traffic flow on a map and textual statistical output that can include metrics such as traffic delays, gap distances, speed and overall trip distance travelled by vehicles.

While macroscopic traffic simulators seem promising for motorways environments they are found to be less suitable for urban scenarios \cite{Bazghandi2012}. Urban environments have a lot of conflicting traffic flows caused by the numerous junctions and small roads that feed and attract traffic from the road network. Also such simulators require accurate OD matrices which cannot be achievable from our dataset due to displacement error created by cell tower location and actual location inevitable considerable distance difference. In our research we tried to focus on both the macroscopic and on the microscopic level since we had a dataset that have ample coverage at our disposition especially in urban areas.    

%TODO - read and add notes from Macroscopic Traffic Flow Model Calibration Using Different Optimization Algorithms

\subsection{Traffic flow detection by trip generation assigned\\ traffic} \label{subsection:methodology:trip_generation}
The method chosen to detect traffic on the road network was to first generate an OD matrix that contains main stay locations for users in a time series. Then a trip is generated between each main location for each user. The trip would include turn by turn directions with longitude and latitude coordinates. Traffic load assignment is then assigned to junctions and turns depending on the time retrieved from OSM (Open Street Maps) data. The major challenge here would prove to be the traffic assignment given that there is an interaction of a lot of vehicles at a given point in time with a complex structure of roads and unexpected events such as weather, accidents and road blockages for whatever reason. 


\section{Main activity hubs extraction and displacement error removal through clustering} \label{section:methodology:clustering}

One of the main steps of the proposed algorithm is to derive main areas of activity from the mobile data usage of subscribers. One possible way to do this from the described dataset is by clustering. Clustering is also used to remove noise caused by displacement through frequent oscillations by finding a centroid of activity. Removal of displacement error through triangulation has been ruled out. There are missing dataset features that are needed to get a more accurate location with this process such as strength of signal from every cell tower that the user connects to. Moreover simple geometrical triangulation does not have the aggregation characteristics that clustering has. Grouping of similar locations have to be implemented on top of triangulation. Triangulation is more suited to remove noise or displacement error caused by cell tower oscillations or handovers. These are caused either because the signal from a tower is weaker from another that can provide better service or there is momentary offloading causing a user to switch his connection to another tower with less load. In section \ref{section:OD_Matrices} it was discussed how certain authors employed various techniques to smooth sudden location change of mobile users because they often switch cell towers in very short time intervals that cannot be attributed to movement. 
 
Clustering is a machine learning unsupervised technique used to classify entities which have similar features. Clustering is done depending on the chosen algorithm and calibration hyper-parameters that control the grouping process. Two clustering techniques that were checked for their appropriateness to this research were k-means and DBSCAN. 

\subsection{K-means clustering} \label{subsection:methodology:kmeans_clustering}
k-means algorithm is highly popular especially for first analysis of datasets because it is simple to implement and highly efficient. The main drawback of k-means clustering its requirement to select the number of clusters you need to find before running the algorithm. Then a number of expected centroids equal to the number of targeted clusters are randomly chosen. The algorithm starts to find the nearest neighbours based on a distance metric until finally the clusters are formed. This process can be run iteratively until the ideal set of centroids with the least root mean square error are found. Also something important to note is that clusters tend to be spherical in nature. This would be highly visible if 2D clusters are plotted on a graph.

\subsection{DBSCAN clustering}  \label{subsection:methodology:dbscan_clustering}
DBSCAN (density based spatial clustering of applications) has an edge on k-means and is mostly suited to our research since it does not need to set the number of clusters that we are after for each user at the outset. Moreover it finds clusters of non-spherical nature and leaves noisy elements out of the computed clusters \cite{ChakrabortyNKNagwaniLopamudraDey2011}. DBSCAN has three main hyper parameters to set namely minimum points,  $\epsilon$ (radius of area within which density is measured)  and a distance metric. The algorithm is more sensitive to density rather than to aggregate distance of surrounding points. Basically the algorithm finds core points that have the required minimum points in its neighbourhood dictated by the distance metric. Other non core points that are within core points' radius range (i.e. they are not surrounded with the minimum number of points) are referred to as boundary points. If clusters formed by the core points overlap each other they form one single cluster, hence the non-spherical shape of the clusters.


\begin{figure}[!]	
	\includegraphics[scale=0.60]{clustering.jpg}
	\centering
	\caption{DBSCAN clustering to find main user activity hubs. (Sample illustration)}
	\label{fig:db_scan_clustering}
\end{figure}
 

DBSCAN was the preferred candidate for clustering since the aim was to find dense clusters of mobile data usage activity and random locations visited by users are of no interest and need to be filtered out. The curse of dimensionality does not apply here since there are only two dimensions with the same scale.  The values of hyper-parameters were 500m for radius, minimum required points was set to 3 and euclidean distance was chosen as the distance metric. The mean distance between a sample of cell tower locations taken randomly from the whole dataset was calculated to be 350m. The radius was chosen to be 500m to allow for overlapping but not include too many cell towers accept for the shouldering ones. By choosing an excessive $\epsilon$ the centroid location coordinates was being too inaccurate and was clustering a wide range of subscribers' activity. With a smaller $\epsilon$ minimal clustering (every cell tower will be start to be considered a cluster) was being attained since cell tower location areas will not overlap. The OPTICS algorithm which does away with the $\epsilon$ parameter iterates until it finds the optimal $\epsilon$ and orders its clusters in a hierarchical result. However this algorithm is more computationally expensive and we opted to use the non-generalized DBSCAN version of the algorithm. The implementation used\footnote{https://github.com/scalanlp/nak} was integrated into Apache Spark processes that output clusters of usage patterns for every user. The output of the implementation we used was in the form of coordinates that outlined the rectangular boundaries of the cluster. The final geographic coordinates that would denote the main activity clusters would be those of the centroid. Therefore the centroid for each rectangular cluster had to be determined with readily available libraries (esri was the used library)\footnote{https://github.com/Esri/spatial-framework-for-hadoop, https://github.com/Esri/geometry-api-java} within Apache Hive.   

%TODO - IMPORTANT - what is the Distribution of the first two clusters on the whole data set.

%TODO - Top two activity locations extraction. What about the third one? Get distribution per user and possible filtering on distribution. Assuming that the top two activity locations for each user are the home and work location.

%TODO - read Dynamic clustering and propagation of congestion in heterogeneously congested urban traffic networks



\section{OD Matrix trip Generation}  \label{section:odmatrix_trip_generation}

To simplify and present in a summarized way a high-level overview is given in the form of pseudo-code in algorithm \ref{algorithm:overview}. The main modules of the algorithm will be discussed in detail in the following subsections.
 
\subsection{OD Matrix computation}   \label{subsection:odmatrix_computation}
In our research we decided to focus on two main areas of activity per user as the basis of our OD matrix generation. Inclusion of more areas of activity is left for future studies (refer to chapter \ref{chapter:future_work}). It is assumed that most of the trips happen between home and work and vice versa. This is based on conclusions encountered in related literature (see section \ref{section:OD_Matrices}). 
The top two clusters per user where retrieved from the resulting users' clusters created with DBSCAN algorithm run. We considered these top two clusters as the origin and destination of trips including returns. Then the user EDRs that have geographical coordinates located in the two main activity cluster areas are filtered into a new dataset through the spatial join technique. This process will produce a dataset containing all data usage records that have a location in either of the top two clusters for any user in a times series. This resulting dataset is substantially the OD matrix.

\subsection{Trip generation, route choice and traffic assignment} \label{subsection:trip_generation}

OD matrices on their own would not give information how traffic flow is distributed on the roads. We needed to detect when trips happen by recording change of user cluster location events. This was achieved by ordering OD matrix entries by user and timestamp. The dataset was then scanned and when location of activity of a given record is found to be different from the previous record, the previous record is tagged as a departure and the current one is set as an arrival. The computations done depending on previous and current rows while scanning a dataset were made by using Apache Hive window analytical functions \footnote{https://cwiki.apache.org/confluence/display/Hive/LanguageManual+WindowingAndAnalytics}. 

%TODO - How many records are of trip duration less than 5 minutes?

There is a caveat on the accuracy of the actual duration of the trip. Records of mobile data usage are generated depending on actual usage at a given location. The frequency of generation of such records would have a direct effect on the accuracy of departure and arrival times for any given trip. The more the temporal resolution is high the more accurate are the departure and arrival times since if the record is generated at a low frequency it cannot be determined with confidence and low margin of error. For example the user might arrive to his work location but he takes too much time to start his first data session. This would add extra trip delay and the resulting trip duration less accurate depending on the gap of time between the actual arrival time and the first generated mobile usage record timestamp. Therefore users with more frequent usage of mobile data have trips with durations with a narrower error margin. Departure times are more precise since these are computed by adjusting the EDR timestamp by adding the data session duration. This will give an accurate timestamp that denote when users leave their clusters.   

%TODO - frequency of mobile usage records and space in between. 

As similarly done in Toole et al. \cite{Toole2015} routes between origins and destinations were inferred from OSM. A route was assigned for each entry in the OD matrix together with duration information from the trip. The user's routing choice was assumed to be the fastest one given by the Open Source Routing Machine\footnote{http://project-osrm.org/docs/v5.15.2/api/\#route-service} (OSRM). OSRM api provides the possibility to request alternative routes. However in the approach taken the route selection was always considered to be static and user does not change route depending on traffic or due to  unexpected events on the road network such as accidents or blockages caused by various other reasons. The fastest route is attributed to each trip done by each user. This may not always be the case since route selection can differ depending on traffic perception and arbitrary route selection made by users. This is a limitation of this research and introduces inevitable bias. It should be noted however that in the urban scenario in Malta the different routes to take towards work and back are limited due to the small scale of the road network infrastructure. In other words there are few possible routes from which users can choose from or that enable detouring, making it highly probable that the fastest path is the preferred choice. In section \ref{section:traffic_flow_evaluation} it is discussed how to measure a level of confidence in the traffic assignment model.


\begin{figure}[hp]	
	\includegraphics[scale=0.60]{Trip_delay_cumm_distribution.jpg}
	\centering
	\caption{Cumulative distribution of trip delay. This figure shows how negative trip delay instances are a very small percentage. Cutoffs  of -5 and 45 minutes were chosen to select the trips for the learning model.  }
	\label{fig:trip_delay_cum_distribution}
\end{figure}

\begin{figure}[!]	
	\includegraphics[scale=0.60]{trip_delay_cumm_distribution_total.jpg}
	\centering
	\caption{Trip delay probability distribution presents a heavy tail on the right.  }
	\label{fig:trip_delay_cum_distribution_heavy_tail}
\end{figure}

Another important extracted information from route selection is the trip delay. The total duration for each trip per user was retrieved from OSRM. The OSRM derived route duration does not account for delays. The difference between the actual trip duration retrieved from observed departures and arrivals per user and the OSRM derived trip duration was considered to be the global trip delay. After computing delays for each trip per user, aggregate statistics were collated to describe typical delays at different hours both in weekdays and weekends. Trip delay difference is evident even between Saturdays and Sundays but is highly regular for weekdays as seen in figure  \ref{fig:trip_delay_weekdays_vs_weekends}. A peculiar observation is the negative trip delays. This can be accounted for by actual trips that were faster than expected and estimated by OSRM. Such negative trip delays are observed during the night when people tend to arrive earlier due to almost in-existent traffic. Average trip delay peaks happen between 6:00 a.m. and 7:00 a.m. and 4:00 p.m. and 5:00 pm. for every weekday. Only one peak can be observed for weekend days.  Saturdays and Sundays peak trip delays are observed later in the day where usually during weekdays average trip delays are smaller. This can be attributed to the fact that people go out later during the day on these two days. Also it is clearly noticeable that for Saturdays and Sundays only one distinct peak can be seen in the distribution and average trip delays per hour are much lower in general.

\begin{figure}[h]	
	\includegraphics[scale=0.60]{Trip_delay.jpg}
	\centering
	\caption{Average trip delay patterns are different between weekdays and weekends. Peaking of average trip delay on weekdays happen at 6:00 a.m and 7:00 a.m. and 4:00 p.m. and 5:00 p.m. Peaks for weekend days happen later in the day.}
	\label{fig:trip_delay_weekdays_vs_weekends}
\end{figure}

Trip delay data had to be further investigated to remove outliers and data that was not suited for the traffic flow count and the machine learning model had to be filtered out. The data model fitted a heavy tailed distribution \ref{fig:trip_delay_cum_distribution_heavy_tail}. Data was skewed to the right because of long trip delays attributed to pauses in trips that are likely caused by intermediate location visits between the main areas of activity. Similarly trip delays less than -5 minutes were mainly attributed to location sudden displacement caused by cell tower switching (see section \ref{section:OD_Matrices} in chapter \ref{chapter:background} ). Cut-off points were set to -5 minutes and 45 minutes for the lower and upper bounds respectively. Consequently 50\% of the data was maintained.  

In OSM technical jargon that describe map objects the route consists in steps that contain manoeuvres. These manoeuvres fields encapsulate geographical coordinates data and duration property after which the driving decision should be taken. The manoeuvres' timestamp was computed by accumulating previous steps duration and add the final total offset to the trip departure timestamp. A new dataset was created with records including previous data structure and steps' information having the timestamp and the coordinates. Therefore the new dataset in addition to the coordinates of mobile users at their origin and their destination had trip geolocation information in the form of trip steps.
 

%TODO - mention how to redistoirubte delay heuristically on steps depending on traffic flow contained in the grid cell where the step was located.

\begin{algorithm}[hp]
	\caption{Experimental Overview}
	\label{algorithm:overview}
	\begin{algorithmic}[1]
		
		\item[]
		
		\BState \emph{\textbf{A. Filter Data}}:
		\Indent	
			\State $\textit{data\_mobile\_usage} \gets \text{filter data usage records from raw \textit{dataset}}$
		\EndIndent
		
		\item[]
		
		\BState \emph{\textbf{B. Main activity locations clustering}}:
		\Indent
		\State $\textit{data\_users\_clusters} \gets \text{run DBSCAN on \textit{data\_mobile\_usage}}$
		\State $\textit{data\_users\_top\_2\_clusters} \gets \text{filter top two user clusters from \textit{data\_user\_clusters}}$
		\State $\textit{data\_users\_top\_2\_clusters\_geo\_data\_points} \gets
				\text{get \textit{data\_users\_top\_2\_clusters} left spatial join \textit{data\_mobile\_usage}}$						
		\EndIndent
		
		\item[]
		
		\BState \emph{\textbf{C. OD Matrix generation}}:
		\Indent
		\State $\textit{data\_users\_top\_2\_clusters\_geo\_data\_points\_sorted} \gets \text{sort by user and datetime } \textit{data\_users\_top\_2\_clusters\_geo\_data\_points}$
		\For{\textbf{each} user group \textit{ug} in $\textit{data\_users\_top\_2\_clusters\_geo\_data\_points\_sorted}$}
			\For{\textbf{each} user record \textit{ur} in \textit{ug}}
				\If {\textit{$ur_t$} cluster id  $\neq$ \textit{$ur_{t-1}$} cluster id (where \textit{t} is timestamp)} 
					\State \textit{$ur_{t-1}$} $\text{departure flag} \gets \text{true}$
					\State \textit{$ur_{t-1}$} $\text{destination coordinates} \gets$ \textit{$ur_t$} $\text{location coordinates}$
					\State \textit{$ur_{t}$} $\text{ actual trip duration} \gets$ \textit{$ur_{t-1}$} $\text{timestamp - }$ \textit{$ur_{t}$} $\text{timestamp}$
				\EndIf
			\EndFor
		\EndFor
		\State $\textit{data\_users\_departures\_arrivals} \gets \text{store final resulting dataset}$
		\EndIndent
		
		\item[]	
		
		\BState \emph{\textbf{D. OD Matrix based trip generation}}:
		\Indent		
			\For{\textbf{each} user departure arrival record \textit{udar} in $\textit{data\_user\_departures\_arrivals}$ }
				\If { \textit{udar departure flag} $=$ true}
				\State $\textit{udar route} \gets \text{derive OSRM route from } \textit{udar origin,destination coordinates}$ 
			
				\State $\textit{udar OSM route duration} \gets  \text{derive OSRM route duration from}$ \par
					\algorithmicindent \textit{udar origin, destination coordinates}
				\State $\textit{udar trip delay} \gets  \text{udar actual trip duration - udar OSM route duration}$						
				
				\EndIf
			\EndFor	
			\State $\textit{data\_users\_trips} \gets \text{store final resulting dataset}$
			\State $\textit{data\_users\_trips\_steps} \gets \text{new empty dataset}$
			
			\For{\textbf{each} user trip record \textit{utr} in \textit{data\_users\_trips} }
		
			    \For{\textbf{each} user trip step \textit{uts} in \textit{utr route}}			    
					\State $\textit{data\_users\_trips\_steps} \gets$ \par
						\hskip\algorithmicindent \text{add new record with step coordinates and timestamp details}
				 
				\EndFor	
			\EndFor			
		\EndIndent			
		
		\item[]
		
		\BState \emph{\textbf{E. Traffic flow spatial binning}}:
		
		\Indent	
	 		
	 		\State $\textit{data\_bin\_traffic\_flow\_time\_series} \gets$ \par 
	 					\text{count traffic flow group by bin id and step timestamp from } \textit{data\_users\_trips\_steps}	
			 	
		\EndIndent		
		
		\algstore{myalg}
			\end{algorithmic}
	\end{algorithm}


\begin{algorithm} [hpt]           
	\begin{algorithmic}[1]           
		\algrestore{myalg}
		
		\BState \emph{\textbf{F. Traffic flow prediction}}:
	    \Indent
		
			\State $\textit{ data\_distinct\_time\_window\_end }  \gets$  $\text{get distinct time window ends from}$ \par
						$\textit{data\_bin\_traffic\_flow\_time\_series}$
			\State $\textit{ data\_distinct\_bin\_ids }  \gets$  $\text{get distinct bin ids from } \textit{data\_bin\_traffic\_flow\_time\_series}$ 
			\State $\textit{ data\_distinct\_time\_window\_ends\_bin\_ids } 	\gets$ $\textit{ data\_distinct\_time\_window\_end } \text{cross join} \textit{ data\_distinct\_bind\_ids }$
			\State $\textit{ data\_sparse\_bin\_count\_time\_series} 	\gets$ \par 
						$\textit{ data\_distinct\_time\_window\_end\_bind\_ids} \text{ left join }  \textit{data\_bin\_traffic\_flow\_time\_series}$ 
			\State $\textit{ data\_time\_windows\_bin\_count} \gets$ \par
			 $\text{two dimensional pivot on } \textit{ data\_sparse\_bin\_count\_time\_series}$ $\text{by bin\_ids}$	
			 
			\State $\textit{ data\_bin\_count} \gets$ $\textit{ data\_time\_windows\_bin\_count}$
			
			
			\State $\textit{ sample\_locations} \gets$ $\textit{ location\_array[a,b,c,d]}$
			\State $\textit{ window\_frames} \gets$ $\textit{ window\_frames\_array[30 min,60 min,180 min,1 day]}$
			
			\item[]
			
			\For{\textbf{each} each bin for location \textit{bin-loc} in  \textit{sample\_locations}}
				\For{\textbf{each} global prediction at \textit{t-ahead} time ahead in \textit{window\_frames}}
					\For{\textbf{each} each record with bin counts \textit{bin-count-record}  for time \textit{t} in \textit{ data\_bin\_count}}						
						\State $\textit{ t-ahead-bin-loc-count} \gets$ $ \text{get bin count for }\textit{ bin-loc } \text{at time} \textit{ t-ahead}$	
						\State $\textit{bin-count-record-with-label} \gets$ \par $ \text{attach} \textit{ t-ahead-bin-loc-count}  \text{ to } \textit{bin-count-record}$				
					\EndFor
				\EndFor
			\EndFor
			
			\item[]
			
			\State $\textit{data\_labelled\_points} \gets \text{store final resulting dataset}$
			
			\State $\textit{ data\_labelled\_points\_reduced} \gets$ \par 
					take first 1000 components of PCA dimensionality reduction of \par 
					\textit{ data\_labelled\_points}
			
			\State $\textit{data\_training} 	\gets$  $ \text{split } \textit{data\_labelled\_points\_reduced} \text{ and get 60\% of data }$
			\State $\textit{data\_testing} 	    \gets$  $ \text{split } \textit{data\_labelled\_points\_reduced} \text{ and get 40\% of data }$
			
			\State $\textit{multilayer\_perceptron\_classifier\_model} 	\gets$  $\text{fit model on } \textit{ data\_training}$	
			\State $\textit{multilayer\_perceptron\_classifier\_prediction\_result} 	\gets$  $\text{run model on } \textit{ data\_testing}$	
			\State \text{report result metrics}
					
			
		\EndIndent 			

	\end{algorithmic}
\end{algorithm}




\section{Traffic flow aggregation through spatial binning} \label{section:spatial_binning}

To get aggregate statistics on traffic distribution hadoop spatial binning was used as proposed in (Eldawy et al,2015) \cite{eldawy2015spatialhadoop}. Hive, which is a data warehouse infrastucture tool running on Hadoop, abstracts a lot of java api calls to get data from distributed file systems managed by Hadoop \footnote{https://en.wikipedia.org/wiki/Apache\_Hive}. Hive has a specific SQL dialect HiveQL(HQL) that can retrieve data from hdfs (hadoop disributed file system) without implementing the mapreduce calls.

Another used tool was Spatial Hadoop which is highly efficient to process geolocation data because it uses MapReduce \footnote{https://hortonworks.com/apache/mapreduce} and a 2-level spatial index. MapReduce executes tasks with a level of parallelism and computation is distributed. Spatial Hadoop uses a special algorithm to partition data in Hadoop and maintains a spatial index for fast querying and fast spatial joins \cite{eldawy2015spatialhadoop}. 

A Hive user defined function (UDF) from esri (esri is the company that owns the ArcGIS solution) is used within the Hive query language (HQL) syntax to count traffic flow by spatial bin\footnote{https://github.com/Esri/spatial-framework-for-hadoop}. A spatial bin is a computational geometry that can be used to numerically describe features in a specific region. In our case we used 0.0005 degrees bins to count traffic flow 'steps' derived from OSM routes. 0.0005 degrees bins approximately equate to 50 by 50 metres bins. We are stating that dimensions are not precise when computing the geometrical bin because dimensions are not strictly universal and vary according to map position. These tend to be more of an elongated rectangle near the poles and squarish near the equator. This happens because latitudes get narrower for bins near the poles due to the fact that the earth is not a perfect sphere but an oblate spheroid\footnote{http://www.longitudestore.com/how-big-is-one-gps-degree.html}. Not withstanding this the bins in the spatial area under investigation are of the same size since Malta does not relatively cover a wide area. We chose $50m^2$ spatial bins to aggregate traffic flow data in order not to have too much wide geometries that can aggregate traffic coming from two roads. Smaller bins than 50 metres square make aggregations less meaningful since aggregation is more near to data points rather than grouping polygons. 

\begin{figure}[!]	
	\includegraphics[scale=0.6]{concentric_map.jpg}
	\centering
	\caption{Traffic flow count through spatial and temporal binning. }
	\label{fig:spatial_binning_traffic_count}
\end{figure}

The centroid for each bin was calculated in order to attain the central coordinates of the polygon delineating the bin. Aggregation was not only done spatially but also temporally within intervals of 5 minutes each. This choice of interval size is quite subjective in nature but it has been decided that it is both granular enough and not too wide to describe traffic flow temporally. Prediction of traffic could then be more practical in terms of time windows ahead relative to the prediction to be done. A larger time window would not permit finer prediction in a time series. For example a non-sliding 10 minute time window which would allow predictions 10 minutes ahead, 20 minutes ahead and so forth. We did not use a sliding window so that we have less data points for training since training of neural networks would be more costly in terms of computation and would have made analysis more time consuming and complex. Having a sliding window would make it more flexible to decouple the averaging window size from the time ahead distance. The prediction time ahead parameter would not need to be a multiple of the averaging window.

\begin{figure}[!]	
	\includegraphics[scale=0.5]{traffic_count_color_coded_categorization.jpg}
	\centering
	\caption{Traffic flow count categorization through a colour coding. Traffic flow count intensity is represented with a colour scheme ranging from dark green (low recorded traffic) to dark red (heavy traffic). The range stretches on 11 quantiles.}
	\label{fig:traffic_count_color_coded_categorization}
\end{figure}

%TODO - possibly move to 
Visual tools such as CartoDB\footnote{https://carto.com} where used to illustrate aggregation of traffic flow count in spatial bins. Figure \ref{fig:spatial_binning_traffic_count} shows which areas attract most traffic in Malta. Well known to be busy traffic flow Locations such as Santa Venera tunnels and Southern Harbour area around the four lane roads in Marsa have bigger distinctive spherical markers. The tool allows to select specific date and time to analyse traffic temporally. A similar visualization depicts average traffic intensity across the whole month under investigation. The tool allows to configure pop ups that can display relative information to the bubble such as location coordinates and average month traffic.

\begin{figure}[h]	
	\includegraphics[scale=0.5]{traffic_month_average.jpg}
	\centering
	\caption{Traffic flow count through spatial and temporal binning. }
	\label{fig:traffic_month_average}
\end{figure}

Another illustration (see figure \ref{fig:traffic_count_color_coded_categorization}) shows through a colour scheme in a categorical manner the intensity of traffic flow. This method makes it easier to categorize traffic flow count than the method used to display traffic in figure \ref{fig:spatial_binning_traffic_count}.   



\section{Traffic flow modelling and prediction} \label{section:traffic_flow_modelling_and_prediction}

%TODO - steps for predicive modelling -> https://www.mathworks.com/discovery/predictive-modeling.html

The hypothesis that traffic flow in all areas is directly correlated to how traffic in a specific given area will be in the immediate future determined how the prediction model has been structured. More specifically traffic flow at any particular bin $b_i$ at time $t$ influences traffic at bin $b_j$ at time $t + n$. The traffic intensity at any given location is a function of other traffic flow count from other bins in preceding time. The computation of traffic in a location based on traffic in the past cannot be achieved by deriving a function based on a mathematical approach. Black box predictive modelling was obtained by training a neural network. There were various steps needed to fit a neural network model which was then used to predict the traffic flow. The aim was to select a sample of locations and predict their traffic. In the following subsections it will be explained how data was processed prior training of the model, how the model hyperparameters were chosen, how the model was eventually trained and then how the model was validated.


%TODO - remove outliers by histogram -> check SPARK:FLATTEN OD TRIPS

\subsection{Preprocessing data for the prediction model} \label{subsection:Preprocessing data for the prediction model}
The first data mining exercise was to build a dataset where each record contains all Malta traffic flow count for every 5 minutes for the month of October 2016 (see table \ref{table:dataset_02}). This dataset was then ordered by time. This dataset was to be derived from the generated dataset in subsection \ref{subsection:trip_generation} which has aggregated traffic flow for each user in a time series with 5 minutes bins. The final resulting dataset from preprocessing would be used to train and validate the artificial neural network (ANN). The features selected to build the model are the traffic flow counts at every location geofenced by a spatial bin. The aggregation process of traffic counts within specific spatial bins was explained in section \ref{section:spatial_binning}.

We used two configurations for traffic classification. Experimentation with the ANN training and validation was done primarily with four labels. Experimentation was also done with eight labels to test how it would perform in comparison. Classification of traffic was done in 4 labels since traffic is labelled similarly in available traffic applications such as Google Maps Traffic \footnote{https://www.google.com/maps} and Tomtom navigation software \footnote{https://mydrive.tomtom.com}. The assigning of the label consisted first of classifying the traffic count of the bin location for every 5 minute window for which prediction modelling is to be carried out.  Then the resulting classification is assigned to the $t - 5n$ record where $n$ is an integer denoting the number of fixed time intervals to predict ahead. Therefore after this operation, table \ref{table:dataset_03} would have another column with future classification of traffic count for a given bin location. Four datasets were prepared for training. These datasets were differentiated by the label assigned. The classification label for each dataset record would be retrieved from time $t+5n$ ahead through window analytical functions for $n$ with values of 3, 6, 12 and 288 which given the 5 minute coverage of each record they reflect time windows ahead of 15 minutes, 30 minutes, 1 hour and 1 day respectively.


\begin{table}[h]	
	\centering
	\resizebox{\textwidth}{!}{
		
\begin{tabular}{|l|l|l|l|l|l|}
	\hline 

\textbf{\Large{bin id}} & \textbf{{\Large longitude}} & \textbf{{\Large latitude}} & \textbf{{\Large time window start}} & \textbf{{\Large time window end}} & \textbf{{\Large traffic flow count}} \\ \hline
4611467925420319675 & 14.4320000001052 & 35.905499999918 & 2016-10-01T00:00:00.000Z & 2016-10-01T00:05:00.000Z & 12 \\ \hline
4611467846458306816 & 14.489500000100501 & 35.918499999953397 & 2016-10-01T00:00:00.000Z & 2016-10-01T00:05:00.000Z & 2 \\ \hline
4611468259490374713 & 14.506000000011101 & 35.850499999983199 & 2016-10-01T00:00:00.000Z & 2016-10-01T00:05:00.000Z & 3 \\ \hline
4611468311119383155 & 14.485500000027001 & 35.841999999986903 & 2016-10-01T00:00:00.000Z & 2016-10-01T00:05:00.000Z & 2 \\ \hline

	\hline 
\end{tabular} }
\caption{A sample of traffic flow count by bin for every 5 minute window.} 
\label{table:dataset_02}
\end{table}


This dataset had traffic flow count for each bin with 5 minute temporal resolution. Traffic counts of zero were not yet present before preprocessing. Therefore the main features of this dataset would be bin id, traffic flow count and time window start and end timestamps. In order to generate a dataset with records that give a snapshot of all traffic count of Malta for every 5 minutes further processing was needed. First all distinct bin ids where extracted and these amounted to 4134. Then all the possible time windows of 5 minutes in the month of October were generated and these amounted to 8928. By performing a cross product between all time series values and all possible bin ids a new dataset with all possible bin id and time window combinations is created. A left join between the original aggregated traffic flow with the latter produced dataset resulted in a new dataset with records that comprehensively describe traffic flow for every 5 minute window for the whole region under study. This data structure was not suitable to be programmatically input to the neural network training and further reorganization was necessary. A data structure where each row contains all traffic flow for all Malta was needed. The columns would be the bin ids that describe all the traffic in all areas. The rows would contain traffic flow count values at a particular 5 minute interval for all these bin ids. To achieve this a two dimensional pivot was used to transform data and traffic per bin. In the resulting dataset the traffic count per bin is stored column-wise. The pivot operation attained data with format as shown in table \ref{table:dataset_03} from data with format as illustrated in  \ref{table:dataset_02}. 


\begin{table}[h]	
	\centering
	\resizebox{\textwidth}{!}{
		
		\begin{tabular}{|l|l|l|l|l|l|}
			\hline 
			
			\textbf{\large{time window timestamp}} & \textbf{{\large bin id 1}} & \textbf{{\large bin id 2}} & \textbf{{\large bin id 3}} & \textbf{{\large ...}} & \textbf{{\large bin id 4134}} \\ \hline
			2016-10-01T00:00:00.000Z & 0 & 0 & 2 & ... & 0 \\ \hline
			2016-10-01T00:05:00.000Z & 0 & 1 & 1 & ... & 1 \\ \hline
			2016-10-01T00:10:00.000Z & 0 & 0 & 0 & ... & 0 \\ \hline
			2016-10-01T00:15:00.000Z & 1 & 0 & 0 & ... & 0 \\ \hline
			
			\hline 
	\end{tabular} }
	\caption{Sparse traffic flow matrix} 
	\label{table:dataset_03}
\end{table}

After all the feature data have been organized in a format that can be processed as input data for the model a label for each data row had to be assigned. ANN is a supervised machine learning type which requires output that can be mapped from input data during the training phase. The output is in our case classification of the level of traffic flow count for a sample location (spatial bin) for which we need to determine the traffic at time $t + 5n$. The output label was not chosen to be the traffic count but a logarithmic function thereof (see Eq. \ref{equation:logarithmic_step_function}).

\begin{equation} \label{equation:logarithmic_step_function}
y=\lfloor{log(x+1)/log(max_x/n + 1) * b}\rfloor + 1  \\
\end{equation}

Where $x$ is the actual traffic flow count, $y$ is the final classification label, $n$ is the step size coefficient (the higher it is the smaller the steps)and $b$ is the number of classification levels (bins). 

\begin{figure}[h]	
	\includegraphics[scale=0.75]{traffic_count_cumm_distribution.jpg}
	\centering
	\caption{Traffic count cumulative distribution for a chosen location. }
	\label{fig:traffic_count_distribution_distribution}
\end{figure}


If a step function with equally spaced intervals was used to classify traffic count, the function label outputs would almost all fall under the first class without meaningful differentiation (see fig. \ref{fig:traffic_count_distribution_distribution}). The skewness towards low counts of traffic is highly decreased with logarithmic binning. The use of logarithmic 'step' function defined in equation \ref{equation:logarithmic_step_function} squeezes indicators in the low traffic flow label bin and widens the range for high level traffic. Note how in figure \ref{fig:label_classification_of_traffic_count_zoom_in} the logarithmic step function with n=2.36 manages to classify  low traffic counts that happen to have high frequency more evenly than step functions with smaller $n$ values. In our experimentation traffic count labelling was done with step size coefficient of 2.36 which proved to give better results for prediction evaluation.

 
\begin{figure}[h]	
	\includegraphics[scale=0.50]{steps_function.jpg}
	\centering
	\caption{Traffic count logarithmic step function. }
	\label{fig:label_classification_of_traffic_count}
\end{figure}

\begin{figure}[h]	
	\includegraphics[scale=0.50]{steps_function_zoom_in.jpg}
	\centering
	\caption{Traffic count logarithmic step function. Lower traffic count mapping. }
	\label{fig:label_classification_of_traffic_count_zoom_in}
\end{figure}


  
%TODO - Traffic may be in decline and on the incline 

%TODO - setting the learning rate



\subsection{Dimensionality Reduction}
The dataset acquired from the original data usage mobile is huge. The features that describe the data amount to 4134 as already aforementioned in subsection \ref{subsection:Preprocessing data for the prediction model}. The planned computational complexity depends on how quickly the model converges. However for each iteration carried out to reduce the cost and undergo gradient descent the magnitude of the computations to be performed depends on the number of training examples multiplied by the number of features multiplied by in turn by the number of neurons in each hidden layer. The number of hidden layers is chosen depending on how much complex the problem is but tends to fall victim of overfitting the model if too many layers are inserted in architecture. As mentioned in \cite{Jain1996} and other literature on ANN design parameters such as number of neurons and number of hidden layers need a trial and error approach to get an architecture that yields better results. Therefore it is important to optimize computation times in order that experimentation that leads to an optimal architecture is less time consuming. Also the final model is simpler and practical in terms of getting a prediction after an acceptable amount of time.

One way how to lower computation time is to reduce the number of features. This entails mapping an n-dimensional space to a smaller dimensional space which reduces the number of features in the process. Raschka  \cite{raschka2015python} states that by reducing dimensionality in data there is less risk of overfitting and thus model can generalize better to testing data.  In \cite{Yang2004} experimentation is done by keeping 95\% and 99\% of the total variance. We chose to keep 324 components that explained 90\% of the total variance. By trial and error it was found that similar results are attained by using 90\% and 98\% of the variance. Original data features showed to be highly correlated so a high degree of compression was possible through PCA. As explained in the formula below \ref{equation:principal_components}


\begin{equation} \label{equation:principal_components}
 \mathop{\text{min}}_k \Bigg\{ k : \frac{{\Sigma }_{i=1}^{k} \lambda_i}{{\Sigma }_{i=1}^{n}\lambda_i} \geq r \Bigg\}
\end{equation}

we selected k to be 324 so that the preserved variance ratio $r$ is 90\%. In equation \ref{equation:principal_components} eigenvalues $\lambda_i$ are ordered in decreasing variance. $n$ represents the original dimensionality of the reduced dataset. In figure \ref{fig:cumulative_variance_pca} it can be observed that the first 324 components explain more than 90\% of the data.

\begin{figure}[h]	
	\includegraphics[scale=0.50]{cumulative_variance_pca.jpg}
	\centering
	\caption{First components contain a higher percentage of the variance. First 324 components explain 90\% of the variance }
	\label{fig:cumulative_variance_pca}
\end{figure}


%
%TODO - some notes on selecting features. 

%TODO - need to compute results with 324 components to get 90% variance 


\subsection{Prediction through Multilayer Perceptron Classifier (MLPC)}


Next step in the data processing pipeline consisted in predicting traffic from a stipulated time ahead for a given location point. This prediction had to be based on data that is harvested some time ahead. All of the original dataset had records with timestamps set  in the past so we simulated prediction of traffic flow by trying to forecast traffic at a certain point in time which is ahead of a given timestamp. Evaluation was carried out with different first PCA components, prediction multi-steps ahead and number of possible classes.

As already explained in subsection \ref{subsection:Preprocessing data for the prediction model} the multi-step time series prediction was evaluated with a variable amount of steps ahead. Each step was already defined to be 5 minutes long. The experimentation was done with 3,6,12 and 288 steps that reflect 15 minutes, 30 minutes, 1 hour and 1 day. These particular prediction time intervals were selected because practically an individual would need to know traffic in certain locations just before he leaves home. Traffic information 3 hours in advance would prove to be irrelevant for a commuter that just leaves home. This applies especially for Malta based trips where distances are relatively short and surely any journey is less than 3 hours. Even transport authorities might not find 3 hours beforehand information useful for management purposes. Individual users leaving at 7.00 am in the morning would contribute information for traffic status at 10.00 am where traffic flow would have eased by then. Therefore we opted to analyse and predict the impact of traffic at 15 minutes, 30 minutes, 1 hour and 1 day before.

%TODO - add references to paragraph below
One of the first decisions was to choose what type of approach for machine learning to take in order to build a model. The problem at hand was complex both because of the number of features and the relation they have with each other. MLPC is a highly non-linear model that can adapt to problems with high complexity. The ANN approach is stated to have the universal approximation property which underlines how an ANN of MLPC type can represent any bounded continuous function to a given arbitrary degree of accuracy \cite{hornik1990universal}. However it is considered to be a black box that is difficult to control and monitor while learning during the training stage. Spark ML MLPC implementation contains intermediate layer neurons that use the logistic function and output nodes that use softmax function \footnote{https://spark.apache.org/docs/latest/ml-classification-regression.html\#multilayer-perceptron-classifier}.

The Spark 2.3.0 implementation that was used makes use of back-propagation to learn the model. It employs the logistic function as an activation function with Limited-memory Broyden-Fletcher-Goldfarb-Shanno (LBFGS) to minimize error \footnote{https://dzone.com/articles/deep-learning-via-multilayer-perceptron-classifier}.  

%TODO - add formulas for logistic and softmax function from https://dzone.com/articles/deep-learning-via-multilayer-perceptron-classifier

The topology choice was determined after carrying out a grid search configured with a set of different hyperparameters. Different configurations for architecture structure were tried out and evaluated until the best performing architecture was chosen. The input and output layers size (number of neurons) are respectively dictated by the number of input PCA extracted features and output classes which are the possible traffic levels indicated by model. Two hidden layers were added to the overall topology. The final configuration after testing different possible architectures consisted of 324 neurons for both the input layer and for the second hidden layer, 400 neurons for the first hidden layer and 4 neurons for the output layer which defined the output classes (see figure \ref{fig:ann_topology}). All architecture layers are fully connected to the successive layer. 


\begin{figure}[!]	
	\includegraphics[scale=0.50]{ann_topology.jpg}
	\centering
	\caption{Multilayer perceptron classifier topology }
	\label{fig:ann_topology}
\end{figure}
 

%TODO - why are more hidden layers needed

The available labelled data points dataset was split into 60\% training and 40\% training. The model with maximum iterations parameter set to 200 showed that after a set of runs it converged consistently. The first phase of setting up the model consisted of the training part where the weights settle to a final value that lead to a minimal error in its classification within the parameter of tolerance set in the configuration. Training outputs a model which is then fitted on the testing data. In the testing phase the prediction efficacy of the model built during training is checked by retrieving certain metrics.

%TODO - maybe add visualization section




\chapter{Evaluation and Results} \label{chapter:evaluation_and_results}
\section{Introduction}


%TODO - Structure
%TODO - evaluation number of trips
%TODO - evaluate trip delay 
%TODO - evaluate traffic flow count
%TODO - evaluate traffic flow prediction (through metrics)

In the systematic approach that was devised to get vehicular traffic related information and to build a prediction model from mobile usage data several stages were involved. Stages in this machine learning pipeline are highly dependent on previous stages' results mainly because each stage feeds its output as input to the next stage. 

Therefore inaccurate results error introduction in early stages would trickle down the pipeline. For example interpretation of error ratio at the prediction stage which is the last stage must be primarily  done in the context of results observed in preceding stages. If traffic counts are not accurately measured the training data itself would not lead to predictions that can be put to practical use. Evaluation plan needs to include evaluation of the following main algorithm operations:

\begin{itemize}
	%\item Clustering of main activity hubs 
	\item Trip counts per hour for weekdays and weekdays
	\item Trip delay average per hour for weekdays and weekends
	\item Traffic flow count in a selection of locations
	\item Traffic count prediction for a selection of locations
\end{itemize}

%\section{DBSCAN Clustering evaluation}

%Clustering was used to retrieve the top two main mobile usage activity locations for users. Ground truth was not available to test how  accurately the resulting main locations for each user were matching the actual ones. DBSCAN clustering as stated in subsection  \ref{subsection:methodology:dbscan_clustering} detects high density cores and then expands clusters. 

\section{Trip counts per hour evaluation}

After determining the daily users' routes between different origins and destinations done there are two sets of important information that are derived. These are namely trip count and trip delay per route. Distributions for both were further derived given that information such as trip departure timestamp is available for every route. 

\begin{figure}[!]	
	\includegraphics[scale=0.5]{Trip_delay_per_day_week.jpg}
	\centering
	\caption{OD matrix generated trip count patterns per day week. To note how Saturdays and Sundays which are outlined by the last and first two peaks respectively have unique traffic delay patterns.}
	\label{fig:trip_distribution}
\end{figure}


One can notice how the trip count distribution per hour derived from mobile usage EDRs (see figure \ref{fig:trip_distribution}) generated OD Matrix is strikingly similar with the trip distribution as reported in a National Household Travel survey (NHTS) done in 2010 \cite{malta2011national} (see figure \ref{fig:trip_distribution_nso}). 


\begin{figure}[!]	
	\includegraphics[scale=0.6]{Transport_malta_trip_distribution.jpg}
	\centering
	\caption{Car trip distribution as reported in Transport Malta 2010 National Survey \cite{malta2011national}.}
	\label{fig:trip_distribution_nso}
\end{figure}

As illustrated in plot \ref{fig:trip_count_correlation} trip count peaks for both reported distributions are observed at 7:00 a.m. and 5:00 p.m. NHTS was taken on a Wednesday and has no car trip distribution for Saturdays and Sundays. Since plot shown in \ref{fig:trip_distribution} show that weekdays' OD generated trips count distribution is similar in shape the average was taken on all weekdays of the whole month. However it should be noted that trip counts on a Monday are distinctively slightly higher than the other weekdays \ref{fig:trip_distribution}. 


\begin{table}[!] \label{table:trip_dsitribution_statistical_analysis}	
	\centering
	\resizebox{\textwidth}{!}{
		
		\begin{tabular}{|l|l|l|l|l|l|}
			\hline
			\multicolumn{3}{|c|}{\large{\textbf{Linear regression statistics}}}\\
			\hline
			\textbf{Pearson correlation coefficient (r)} & \textbf{ Degrees of freedom} & \textbf{ p-value}  \\ \hline
			0.94 & 22 &  $1.13628e-11^*$ \\ 
			\hline			
			
	\end{tabular} }
	\caption{NHTS and OD trip distributions proved to be highly correlated. $ ^* p < 0.001$  } 
	
\end{table}

The dynamics of the plot show how there is a sudden decrease of trips per hour after 7:00 a.m. that continues till 11:00 a.m. when trips start to rise again to gradually ramp up. The gradient suddenly increases again at 3:00 p.m. The increase and decrease of trip rate around the 5:00 a.m. peak is smoother than then the one observed in the morning peak for both distributions as we (see figure \ref{fig:trip_count_correlation}). 


\begin{figure}[!]	
	\includegraphics[scale=0.6]{Trip_count_correlation.jpg}
	\centering
	\caption{Comparison between OD average trip distribution over a month and Transport Malta 2010 survey results (\cite{malta2011national})}
	\label{fig:trip_count_correlation}
\end{figure}


NHTS \cite{malta2011national} reports 11\% in car trips from 1998 to 2010 and as shown in plot in figure the distribution again shows resemblance. Both the relationship between HTS datasets gathered in 1998 and 2010 and the relationship of these to the existent OD generated trip dataset demonstrate that trip distribution increases evenly with a specific scale factor across the hours as years go by.


\begin{figure}[!]	
	\includegraphics[scale=0.5]{Trip_distribution_line_fit_plot.jpg}
	\centering
	\caption{Linear relationship between OD average trip distribution over a month and Transport Malta 2010 survey results \cite{malta2011national}}
	\label{fig:trip_count_correlation_model}
\end{figure}

A linear regression model was devised to express the scaling up from trip distribution in 2010 and the one registered in 2016 in this study. A correlation statistical analysis would have sufficed to establish a linear relationship. There is definitely no causality relationship between these two variables. However a regression model was fitted to the data to express how scaling up of counts can be done from the OD generated one to actual data that is collected through surveys (see figure \ref{fig:trip_count_correlation_model}) . Results are reported in table \ref{table:trip_dsitribution_statistical_analysis} and these show that there is a significant positive relationship between trip distributions.


\section{Trip average delay per hour evaluation} \label{section:trip_average_delay_evaluation}

\begin{figure}[!]	
	\includegraphics[scale=0.5]{trip_delay_mosta_marsa.jpg}
	\centering
	\caption{Expected trip delay 7 day distribution retrieved with Google distance matrix API for Mosta to Marsa route. Note how Sunday and Saturday delay pattern is different from the one observed for weekdays.}
	\label{fig:trip_delay_mosta_marsa}
\end{figure}

Evaluation of average global trip delay results computed from OD and OSRM generated trips (OD-OSRM) proved to be challenging because ground truth data could not be found in literature of similar research type and local transport authorities reports. In the NHTS (2010) \cite{malta2011national} in addition to trip count statistics it is mentioned that a detailed matrix with trip information including departure and finish time was compiled. Correspondence with Transport Malta to attain such data or similar information proved to be futile up to the date of completion of this work. 


\begin{figure}[h]	
	\includegraphics[scale=0.7]{trip_delay_comparison.jpg}
	\centering
	\caption{DMAPI expected average trip delay comparison with OD-OSRM computed average trip delays}
	\label{fig:trip_delay_google_vs_mine}
\end{figure}


At the end of April 2018 Google maps made available traffic information overlay on its maps. In addition to this Google Cloud distance matrix API  (DMAPI) exposed a web service that gives duration and duration in traffic of trips that are defined with origin and destination for Malta as well.

\begin{table}[!]	
	\includegraphics[scale=0.7]{trip_delay_correlation_DMAPI_vs_MINE.jpg}
	\centering
	\caption{Correlation statistics between DMAPI routes' average trip delay and DMAPI routes' correlation with OD-OSRM computed trip delay. Note that correlation is being done between data retrieved in June for DMAPI and data retreived in October for OD-OSRM}
	\label{table:trip_delay_google_vs_mine}
\end{table}


The trip delay model built through the OD matrix is a basic statistical one that gives average trip delay per hour. Google distance metric API gives estimated duration information (with traffic and without) by specific route. In order to compare the estimations of our model with the Google one for the local traffic a data-mining process that scraped a data set of trip delay through the DMAPI web service was carried out. Seven whole days of data from June 2018 was scraped by retrieving duration information for every quarter of an hour (see fig. \ref{fig:trip_delay_mosta_marsa} for an example). Estimated trip delay is calculated by subtracting estimated trip duration from trip duration in traffic. Average trip delay was then computed per hour. This process was done for four different routes namely Mosta to Marsa, Mellieha to Swieqi (MS), Birkirkara to Sliema (BS) and Valletta to Mgarr (VM) and the overall trip delay average was calculated on these routes' data. These routes were chosen for two reasons. First these were chosen because they represent routes that are really varied in type in what is direction and areas covered by the trip in Malta. The second reason why they were chosen was because the average time of the selected route trips which is retrieved from Google API (24 minutes) approximates the global trip average time which is reported for a car trip in \cite{malta2011national} (20 minutes). To be noted however that from 2010 trip delay likely increased due to further load of traffic on the road infrastructure.

Correlation results showed that there is a strong linear relationship between the routes' trip delay pattern which were investigated with the DMAPI. Correlation between DMAPI and OD-OSRM trip delay estimation is less but still considerable. Between DMAPI average overall trip delay and OD-OSRM non shifted expected trip delay data there is a correlation of 0.69 \ref{table:trip_delay_google_vs_mine}.

When comparing trip expected delays one can notice some distinctive features that differentiate OD-OSRM trip delay plot and the DMAPI ones. Trip delays are higher in OD-OSRM data than for DMAPI. Also pattern for plots based on DMAPI retrieved trip delay data tend to have delays peaking distinctively higher in the morning rather than in the afternoon. Also OD-OSRM trip delay morning peak comes 1 hour earlier. The fact that more trip delay is observed for the OD-OSRM dataset can be attributed to the fact that in October there is much more traffic. It is known that in Malta October is one of the most chaotic months for traffic because schools and colleges would have just started. In June the University of Malta semester is almost closing (no more lectures are being held) and primary and secondary students leave school just after noon. Government departmental workers start to work till mid day in mid June as well. The earlier peak observed in the OD-OSRM data can be explained in the light that in October to cope with the heavy delays on the roads commuters leave earlier to avoid traffic congestion. When shifting the OD-OSRM data by one hour (see dotted line in fig. \ref{fig:trip_delay_google_vs_mine} ) a higher correlation of 0.78 is observed with (DMAPI) overall average trip delay.

The fact that data has different seasonality is a serious limitation in the evaluation of the OD-OSRM trip delay model with DMAPI data as ground truth. Given that at the time of writing results could not be recomputed for OD-OSRM for June it was attempted to get DMAPI webservice estimations data for October 2018. DMAPI does not give responses for data queries that request past data. However it can give expected trip duration data in the future even if is queried from months ahead. The data retrieved for 7 days in October 2018 with DMAPI from four months in advance was exactly the same as the one retrieved for the same route in June. Therefore there was not the possibility to evaluate our model with DMAPI data from the same month which was expected to a have a more similar pattern. Still within the perspective of knowing how traffic in June and October is different and the strong correlations between the trip delay estimation models there is a good confidence level in relying on the OD-OSRM trip delay estimation data.	

\section{Traffic flow count evaluation} \label{section:traffic_flow_evaluation}

Route information was retrieved from OSRM with the OD matrix as input. Thus with a matrix of origins and destinations each trip done by any user was assigned a route (refer to method discussed in \ref{subsection:trip_generation}). The fastest route was retrieved from the OSRM and alternative routes were not considered. This is decisive together with OD matrix computation to characterize the model of how traffic assignment is done to the road infrastructure. The average OD-OSRM computed traffic flow count was compared with average actual traffic flow counts at the same locations at the same exact date and time in order to analyse how accurately the traffic assignment distributes traffic flow with fastest route as default selection.



%---------------------------------- TRAFFIC FLOW COUNT NIGEL PACE VS MINE -------------------
\begin{figure}[!] \label{fig:kappara_north_traffic_flow_line_chart}
	\centering
	\begin{subfigure}{0.6\textwidth}
		\centering
		\includegraphics[width=\linewidth]{traffic_flow_count_KN_MINE.jpg} 
		\caption{\scriptsize{Traffic flow Count Kappara North - OD-OSRM}} 
		\label{fig:traffic_flow_count_KN_MINE}
	\end{subfigure}
	
	\vspace{1cm}
	\begin{subfigure}{0.6\textwidth}
		\centering
		\includegraphics[width=\linewidth]{traffic_flow_count_KN_Nigel_pace.jpg} 
		\caption{\scriptsize{Traffic flow Count Kappara North - video stream count}}
		\label{fig:traffic_flow_count_KN_NP}
	\end{subfigure}
	
	\caption{Kappara North Traffic flow counts from OD-OSRM and video stream count comparison. Video stream count graphic has been reproduced from \cite{Pace2017}.}
\end{figure}

\begin{figure}[!] \label{fig:kappara_south_traffic_flow_line_chart}
	\centering
	\begin{subfigure}{0.6\textwidth}
		\centering
		\includegraphics[width=\linewidth]{traffic_flow_count_KS_MINE.jpg} 
		\caption{\scriptsize{Traffic flow Count Kappara South - OD-OSRM}} 
		\label{fig:traffic_flow_count_KS_MINE}
	\end{subfigure}
	
	\vspace{1cm}
	\begin{subfigure}{0.6\textwidth}
		\centering
		\includegraphics[width=\linewidth]{traffic_flow_count_KS_Nigel_pace.jpg} 
		\caption{\scriptsize{Traffic flow count Kappara South - video stream}}
		\label{fig:traffic_flow_count_KS_NP}
	\end{subfigure}
	\caption{Kappara South Traffic flow counts from OD-OSRM and video stream count comparison. Video stream count graphic has been reproduced from \cite{Pace2017}}
\end{figure}


\begin{figure}[!] \label{fig:marsa_north_traffic_flow_line_chart}
	\centering
	\begin{subfigure}{0.7\textwidth}
		\centering
		\includegraphics[width=\linewidth]{traffic_flow_count_MN_MINE.jpg} 
		\caption{\scriptsize{Traffic flow count Marsa North - OD-OSRM}} 
		\label{fig:traffic_flow_count_MN_MINE}
	\end{subfigure}
	
	\vspace{1cm}
	\begin{subfigure}{0.7\textwidth}
		\centering
		\includegraphics[width=\linewidth]{traffic_flow_count_MN_Nigel_pace.jpg} 
		\caption{\scriptsize{Traffic flow count Marsa North - video stream}}
		\label{fig:traffic_flow_count_MN_NP}
	\end{subfigure}
	\caption{Marsa North Traffic flow counts from OD-OSRM and video stream count comparison. Video stream count graphic has been reproduced from \cite{Pace2017}.}
\end{figure}

\begin{figure}[!] \label{fig:marsa_south_traffic_flow_line_chart}
	\centering
	\begin{subfigure}{0.7\textwidth}
		\centering
		\includegraphics[width=\linewidth]{traffic_flow_count_MS_MINE.jpg} 
		\caption{\scriptsize{Traffic flow count Marsa South - OD-OSRM}} 
		\label{fig:traffic_flow_count_MS_MINE}
	\end{subfigure}
	
	\vspace{1cm}
	\begin{subfigure}{0.7\textwidth}
		\centering
		\includegraphics[width=\linewidth]{traffic_flow_count_MS_Nigel_pace.jpg} 
		\caption{\scriptsize{Traffic flow count Marsa South - video stream}}
		\label{fig:traffic_flow_count_MS_NP}
	\end{subfigure}
	
	\caption{Marsa South Traffic flow from OD-OSRM and video stream counts comparison. Video stream count graphic has been reproduced from \cite{Pace2017}.}
\end{figure}

%-----------------------------------------------------------------------------------------------------

The ground truth to be used is acquired from work done by Nigel Pace in his dissertation submitted in 2017 \cite{Pace2017}. Directional Traffic flow counts were manually gathered from web camera recorded streams from four locations. These were gathered from Kappara and Marsa roadways for traffic which is both northbound and southbound. The Marsa roadway is referred to as the Marsa-Hamrun bypass which is the road leading to and from the Santa Venera tunnels. These roads are known for heavy traffic load and congestion in Malta. The Kappara roadways get and feed traffic to the old Kappara roundabout which today has been replaced by a flyover. The dates for the data collection were from Monday 17th of October to Friday 21st of October. Data for the day of Tuesday the 18th of October was missing from the dataset and there was no particular reason specified why this it was missing. The traffic flow count consisted of an average traffic flow count per minute taken over intervals of 15 minutes. This resulted into 44 samples for data gathered from 6.00 a.m to 8.45 a.m. for every day. An daily average for every quarter of an hour was then taken for both the actual data and the one generated with OD-OSRM.   


%---------------------------------- TRAFFIC FLOW COUNT LINE PLOTS -------------------

\begin{figure}[!] \label{fig:kappara_traffic_flow_count_plot}
	\centering
	\begin{subfigure}{0.8\textwidth}
		\centering
		\includegraphics[width=\linewidth]{traffic_flow_count_KN_line_plot.jpg} 
		\caption{\scriptsize{OD-OSRM and video stream traffic flow Count linear plot - Kappara North}} \label{fig:traffic_flow_count_KN_lineplot}
	\end{subfigure}
	
	\vspace{1cm}
	\begin{subfigure}{0.8\textwidth}
		\centering
		\includegraphics[width=\linewidth]{traffic_flow_count_KS_line_plot.jpg} 
		\caption{\scriptsize{OD-OSRM and video stream traffic flow Count linear plot - Kappara South}}
		\label{fig:traffic_flow_count_KS_lineplot}
	\end{subfigure}
        \caption{OD-OSRM and video stream traffic flow Count linear plot for Kappara traffic flow points.}
\end{figure}

\begin{figure}[!] \label{fig:marsa_traffic_flow_count_plots}
	\centering
	\begin{subfigure}{0.8\textwidth}
		\centering
		\includegraphics[width=\linewidth]{traffic_flow_count_MN_line_plot.jpg} 
		\caption{\scriptsize{OD-OSRM and video stream traffic flow Count linear plot - Marsa North}} \label{fig:traffic_flow_count_MN_lineplot}
	\end{subfigure}
	
	\vspace{1cm}
	\begin{subfigure}{0.8\textwidth}
		\centering
		\includegraphics[width=\linewidth]{traffic_flow_count_MS_line_plot.jpg} 
		\caption{\scriptsize{OD-OSRM and video stream traffic flow Count linear plot - Marsa South}}
		\label{fig:traffic_flow_count_MS_lineplot}
	\end{subfigure}	
	\caption{OD-OSRM and video stream traffic flow Count linear plot for Marsa traffic flow points.}
\end{figure}

%-----------------------------------------------------------------------------------------

A simple linear regression model was fitted for each location to analyse the type of relationship between the OD-OSRM traffic flow counts and actual traffic flow count data used from \cite{Pace2017}. There is no implied cause and impact relationship. It was attempted to determine whether a true actual traffic flow count can be determined with a linear regression model from OD-OSRM traffic flow data. The resulting models are evaluated to determine how the independent variables which are location OD-OSRM traffic flow counts explain the variance of actual traffic flow. The null hypothesis here is that there is no significant functional mapping of actual traffic counts by OD-OSRM traffic counts for any specific road section.


\begin{table}[!]	
	\includegraphics[scale=0.4]{traffic_flow_counts_correlation_results.jpg}
	\centering
	\caption{Correlation statistics for linear regression models. OD-OSRM traffic flow count is the predictor variable and video stream traffic count is the dependent variable. $^*$Results are all significant with $p < 0.05$.}
	\label{table:traffic_flow_correlation_results}
\end{table}

Results include Pearson's correlation coefficient, $R^2$ which indicates the explained variance and p-value which shows that all results are statistically significant. Degrees of freedom value was 43 for each directional flow under study since there was one independent variable and 44 sample data points were available for each traffic flow point under examination. These results are shown in table \ref{table:traffic_flow_correlation_results}. From the results' table one can conclude that there is a strong correlation between OD-OSRM and actual traffic flow counts for both Kappara carriage ways. The strong correlation is well illustrated with line plot shown in fig. \ref{fig:kappara_traffic_flow_count_plot}. Line charts presented in fig. \ref{fig:kappara_north_traffic_flow_line_chart} and fig. \ref{fig:kappara_south_traffic_flow_line_chart} that illustrate traffic count for both Kappara carriageways show that traffic fluctuation patterns are very similar. On the contrary there is a weak negative correlation for Marsa traffic flow points (see table \ref{table:traffic_flow_correlation_results} and line plots in fig. \ref{fig:marsa_traffic_flow_count_plots}). In fact if one analyses traffic flow charts in fig. \ref{fig:marsa_north_traffic_flow_line_chart} and fig. \ref{fig:marsa_south_traffic_flow_line_chart}  one can see that while actual traffic flow count starts high at 6.00 a.m. and gradually slows down up to 9.00 a.m. in OD-OSRM traffic flow charts shows that traffic increases constantly and peaks at 7.30 a.m. and then it starts to decrease for the subsequent later average samples. Traffic flow in Marsa traffic points does not necessarily mean that traffic flow is slowing down because there is less traffic load. Traffic slows down because of increase in traffic congestion \cite{Pace2017}.

Therefore an explanation why there is strong correlation with Kappara traffic flows but a weak negative one with Marsa located traffic flows can be based on the fact that traffic tends to be slower in Marsa traffic flow points when compared with Kappara traffic flow points. OD-OSRM measurements are based on trips that have been detected but if actual vehicular traffic slows down due to congestion the OD-OSRM traffic flow count does not reflect actual traffic counts. Therefore two conclusions are derived from this. A first conclusion is that reliable regression models can be trained on actual traffic data for traffic flow road sections which do not experience heavy traffic slow down.  Secondly the regression model mapped traffic flow counts give a reliable account of what flow capacity is 'expected' to be serviced at any given time from a given road section in order that traffic flows smoothly. 

\section{Traffic flow count prediction for a selection of locations evaluation}

In section \ref{section:traffic_flow_modelling_and_prediction} an approach how to predict traffic flow count for specific road sections was presented. The model proposed is an MLPC that as a function takes the traffic flow count from each recorded location as input and predicts an approximative traffic flow count for a specific location/road section for a date time in the immediate relative future. The traffic flow counts are binned in specific labels through a logarithm based function. Traffic flow count is represented with 4 bins which are equivalent to the model's classes. These classes range from class one to class four with class one being the lowest indicator of traffic flow count and class four being the highest. The MLPC model was devised by dedicating 60\% of the data for training and 40\% of the data for testing. Since Neural networks require a lot of data to train properly no data was dedicated for validating the models when searching the optimal hyper  parameters such as neural network topology layout and PCA first k components. A trial and error approach was used to check how the model would perform when changing such hyperparameters. Testing was done only for the application phase to evaluate how the model would perform with real-world data. 

Collected performance metrics include accuracy and weighted precision, recall and f1-score. Accuracy gives a very basic picture of how the model is performing. However it does not give clear information how the model is performing across all traffic flow count classes. The locations chosen from the available dataset possesses the property of unbalanced classes. For example if a given location has 95\% of classes of type one a model which always predicts class one will be 95\% accurate on testing. Weighted precision and weighted recall further describe the performance of the model. When having a high precision and a low recall the model is more appropriate for exactness in classification (false positives are kept at a minimum at the cost of a high number of false negatives). A high recall and low precision model is better in identifying  a higher percentage of classes correctly but can output a relatively high number of false positives in the process.   

In machine learning sometimes high recall is more important then high precision or the other way round and in most of the times there is a trade-off. The more you tune the model to have one of these metrics better the more you risk to get a lower performance on the other metric.  The ideal is to have both high recall and high precision. In the case of this study recall for high level of traffic classes is very important since knowledge of high traffic count is important and noise would be acceptable. Weighted f1-score was used to portray a balanced measure between recall and precision.

\begin{table}[t!]	
	\includegraphics[scale=0.75]{classification_metrics_result.jpg}
	\centering
	\caption{Classification evaluation metrics for 4 traffic flow road sections with 4 label classification and PCA set to extract 324 first components. Testing was done with 4 sizes of prediction time window ahead for each prediction location.}
	\label{table:classification_mertrics}
\end{table}

Table \ref{table:classification_mertrics} shows evaluation results described by metrics just discussed. It can be seen that models trained to predict for smaller time ahead intervals generally perform better than models that are trained with a lengthier prediction time interval for the same location.  Models all have proven to have highest recall and precision for class one traffic flow counts. It appears from table that the best overall classification metric scores were attained for Hamrun-Valletta roadway. However on examination of the confusion matrix (shown in fig. \ref{fig:confusion_matrix_hamrun_valletta_15min}) for classification results per label one can see that the model performed very badly for high traffic flow count classes. There are not evaluation metrics results for class four and for class two and three the precision and recall metrics are very low.In fact when computing the f1-score for class wo and class three both results to be low at 0.14 and 0.0 respectively. In contrast predictive overall results for Marsa road that leads to Aldo Moro are less promising than those for Hamrun-Valletta arterial road. Still the predictive efficacy results are very good especially when examined in the perspective of the confusion matrix shown in fig. \ref{fig:confusion_matrix_marsa_aldo_moro_15min}. Class four classified as class one or class two cases are very few and even if almost half of class four test values were predicted as class three in practice this would still make the model useful and offer guidance to describe the level of high traffic flow counts.


\begin{figure}[h]	
	\includegraphics[scale=0.5]{confusion_matrix_hamrun_valletta_342_4bin_15min.jpg}
	\centering
	\caption{Confusion matrix for hamrun-valleta road traffic flow count for 15 minutes ahead prediction interval.}
	\label{fig:confusion_matrix_hamrun_valletta_15min}
\end{figure}

\begin{figure}[h]	
	\includegraphics[scale=0.5]{confusion_matrix_marsa_aldo_moro_342_4bin_15min.jpg}
	\centering
	\caption{Confusion matrix for marsa to aldo moro road traffic flow count for 15 minutes ahead prediction interval.}
	\label{fig:confusion_matrix_marsa_aldo_moro_15min}
\end{figure}




%TODO - test with smaller PCA


%TODO - test with weekdays only

\chapter{Future Work} \label{chapter:future_work}

\section{Future improvements}



\subsection{Use of alternative data sources for ground truth}
The challenge in such projects is to find ground truth to properly evaluate findings and achieved results. One way to achieve this is to develop or use off the shelf software that collects GPS points and collaborate with a group of people to gather the data. The resulting sample of data would be ideal to carry out correlations with experimental outcomes.

\subsection{Clustering optimization}
DBSCAN was used to find density based clusters to extract most common origin and destination locations for users. As discussed in section \ref{section:methodology:clustering} $\epsilon$ was set to 500m. The OPTICS is an algorithm which is similar to DBSCAN which does not require $\epsilon$ parameter as an input and is more efficient to find meaningful clusters for data with varying density. Clusters in this research that had a weak density might have not been captured with a radius of 500m. DBSCAN was computationally expensive and consumed a lot of time in the experimentation phase. An optimization for the performance of the proecessig of the whole pipeline would be running DBSCAN on data in parallel in a distributed manner. An implementation based on the Spark platform is proposed in \cite{huang2017research}.

\subsection{Route selection}
One limitation in this dissertation was to assume that users take always the fastest route and do not detour for whatever reason along the trip. Traffic assignment therefore is static and does not adapt to the traffic events on the road infrastructure. This would not give optimal results when gathering real-time and historical analytical statistics on routes, trips and distributed traffic load on the road infrastructure. Other methods must be combined with the proposed solution to rectify route selection and give a more realistic picture of traffic flow based on actual user route taking. One way how to improve correct route selection rate is by further polling mobile usage data during a user trip and snap the user to the nearest road route with snap to road software such as Roads API from Google\footnote{https://developers.google.com/maps/documentation/roads/snap}. This type of software takes a set of coordinates as input and returns a similar set of data that most likely define the route outlined by the set of data. Route selection would not be necessarily computed for each user every time a user trip is detected. A statistical model is built to learn what are most likely routes taken by each user in a given date and time context. This model then in the application phase can be used to analyse traffic load which is related to the predicted routes.

\subsection{Efficient traffic flow count noise filtering}
An averaging moving filter would remove noise from the traffic flow count and improve results by applying a smoothing function. When getting a sliding average more data points can be used for prediction. In our approach to reduce computation costs average with binning size of 5 minute each was calculated but this would reduce a 60 data point resolution to 12 data points in an hour. When building a machine learning model that predicts traffic flow count a fixed interval was used to get the future classification label (refer to section \ref{section:traffic_flow_modelling_and_prediction}). This fixed interval had to be a multiple of the 5 minute window and there was no flexibility for more granular tuning. Having less data points for the reasons just mentioned provided less data for training to the MLPC.

\subsection{Evaluate trip average delay by correlating with data with same seasonality}
Evaluation for \ref{section:trip_average_delay_evaluation} was done by comparing results based on a June dataset with data retrieved through DMAPI and an October mobile data usage dataset. This evaluation although it gave promising results should be repeated with seasonality of datasets removed from the equation to compare like with like. Malta traffic in October is very different from Malta traffic in June. 


\section{Future research and potential projects}

\subsection{Machine learning for trip delay prediction}

In this research machine learning was used to train an MLPC with all locations' traffic flow count as data features. All the traffic flow count would be mapped by a built model to a level of traffic representing the future traffic flow count for a specific location. A similar predictive model can be built to predict estimated trip delay for every given route for any given required time. A comprehensive used routes database that exists in Malta for all users based on the OD matrix has to be compiled. Than statisictical information on trip delays per 5 minutes for same routes are aggregated. One should investigate the possibility of using routes' trip delays as training input features to a machine learning model. The final predicted classification would be a trip delay class for certain give routes. The model basically would be a function that maps trip delays for a set of routes to a classification of trip delay for a given route.

\subsection{Analysis of more activity hubs and how they affect traffic flow}

In order to keep this study simple and not increase the evaluation combinations only two main clusters' location were retrieved per user. These two clusters were considered as being the home and work locations. However the main relevant assumption was that most trips were made between these two main clusters. This is not representative for all trips made and would incur phantom trip delays that could only be explained by stops at locations frequently visited by users that are not one of the main activity clusters. A fact that heavily impacts daily traffic in Malta are extra trips that their destinations are concentrated around schools. School run trips can be detected by extracting the third most common location that is located within a school geofencing boundary and by time boxing with school starting and finishing hours. A lot of trips have been discarded with the used methodology because they had excessive delays. Many of these trips can be retained to better explain the traffic dynamics if trips are further divided with the insertion of a third location.

\subsection{Use of other datasets to increase traffic flow model accuracy }

Other datasources such as social media and ANPR video streams could be used to further dynamically assign traffic to the road network. From social network feeds one can extract for example accidents location and time. This data could be used to analyse the accident impact on traffic flow and can be used as an input feature for machine learning models. Also correlation between weather and traffic flow can be done by using available weather APIs.


\chapter{Conclusion}
 
Through a systematic approach a data processing pipeline was devised to extract vehicular traffic patterns from mobile usage data. The methodology consisted in building models for each pipeline phase that processed input data and fed next phases down the chain. The ensuing ensemble of techniques can be applied to deduce traffic analytics from time series mobile usage data. 

The aforementioned pipeline models include users' activity hubs clustering, OD matrix based trip generation, trip delay information and traffic flow measurement and prediction. Clustering was used to create an OD matrix containing data on visits done to the two top locations where users made most use of mobile data. Trips were generated between every recorded departure from origin and arrival to destination and the resulting trip duration. OSRM was used to retrieve routes for these trips an get the actual estimated trip duration without traffic. The difference between the OSRM trip duration and the actual trip duration recorded from OD trip generation was considered to be the trip delay statistical information. OSRM was used as well to collect time series data that indicated where the traffic flow is being distributed on the road infrastructure in order to build aggregate statistical models. The traffic flow counts' dataset then was used to train an MLPC to build a model that predicts traffic flow count at varied time intervals ahead.

Clustering was the only part of the methodology that could not be evaluated directly. Ground truth was not available to test how  accurately the resulting main locations for each user were matching the actual ones. Its evaluation relied on traffic flow count evaluation which is highly dependent on the OD-OSRM generated trips which are defined by the users' main two clusters.

Since the mobile users population does not match the number of commuters that use their own vehicle for transportation it was expected that trip distribution statistics would give lower values than those reflected by actual values. A scaling up method was needed to extrapolate real world trip distribution statistics. A very strong correlation of 0.94 was found between average NHTS 2010 trip distribution data and trip distribution generated by OD-OSRM. A linear regression model was built to map OD-OSRM figures to scaled up numbers. One should underline the fact that a lot of human resources are needed to collect survey data and that surveys become eventually outdated. The method proposed in this research uses readily available data, is dynamically updated and have a 5 minute temporal resolution. Survey responses may not contain exact departure and arrival times since people possibly tend to round these when replying.

Correlation statistics were carried out for trip hourly average delay for four different routes. A promising overall correlation of 0.72 was found between trip delay data originating from OD-OSRM and Google's DMAPI. However one must note that DMAPI data was collected for a week in the month of June 2018 and OD-OSRM data was collected in October 2016. Our approach is better to give predictive models for the distant future.

Traffic flow distribution linear regression models were built to map OD-OSRM traffic flow distribution to actual ones. The linear relationship with data collected manually for four locations was analysed. It was concluded that the linear relationship is statistically significant and tends to have high correlation if the road traffic flow capacity is not exceeded. Otherwise for locations that tend to have high traffic congestion, correlation is both low and negative during traffic congestion time. Therefore it is concluded that negative correlations in traffic flow distribution linear models indicate that locations are experiencing slowing down of traffic due to congestion.

Machine learning techniques were employed to predict traffic flow counts at a given time for a given location from previous traffic flow counts at an earlier time for all location data points. An MLPC was trained for four locations and prediction intervals ranged from 15 minutes to 1 day. Satisfactory results were attained and from these results it is concluded that users or information support systems can make well informed decisions on predicted traffic flow data for selected locations.

The main strength of this dissertation was to give an accurate measure and an effective prediction of traffic flow demand (not traffic congestion) on the road infrastructure. The insight gained would help transport agencies' administrators to tackle infrastructure problems before they eventually happen. Improvement is mainly needed on dynamic traffic assignment.

 
 
\appendix

\chapter{This chapter is in the appendix}
\section{These are some details}
%%example of the code environment
\begin{code}
this is some code;
Make sure to use this template.
\end{code}


\bibliomatter
\bibliographystyle{abbrv}
 \bibliography{references}
 
\end{document}
